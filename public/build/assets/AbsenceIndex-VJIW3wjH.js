import{d as ee,r as v,D as d,w as z,c as U,u as te,a as b,o as n,b as y,e as C,f as o,V as se,g as ae,h as A,n as le,i as l,j as c,k as W,F as _,l as h,m as w,p as S,q as Q,s as q,t as I,v as ne,x as oe,y as re,z as ue,A as de}from"./app-B0tzRfiS.js";import{A as ie}from"./AdminLayout-GlABh3cB.js";import{t as ce,u as ye}from"./utils-D85Mb-qf.js";import{_ as me}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-BV-LnaYi.js";import{_ as ve,g as pe}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-DPYX4IeL.js";import{_ as fe}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-Bo-IwSf8.js";import{_ as be}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang-tssC1uQB.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"d-flex flex-wrap align-center"},he={class:"d-flex"},Me={class:"d-flex"},ke={key:0,style:{width:"64px"}},Fe={key:0,style:{"max-width":"calc(100vw - 28px * 7)","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"},class:"px-sm-4 px-1"},ge={key:0},Ae={key:1},De=ee({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absence_types:{},holidays:{},schoolHolidays:{},date:{},user_absence_filters:{},federal_state:{},all_federal_states:{}},setup(G){const p=G,T=route().params.date,a=v(T?d.fromFormat(T,"yyyy-MM"):d.now()),M=useForm({set:null,selected_users:[],selected_absence_types:[],selected_statuses:["created","accepted"],selected_holidays:[p.federal_state]}),k=useForm({set:null,selected_users:[],selected_absence_types:[],selected_statuses:["created","accepted"],selected_holidays:[p.federal_state]}),r=v(k);z([()=>k.data(),()=>M.set],()=>{M.set==null?r.value=k:r.value=M},{deep:!0});const J=U(()=>[].concat(p.absencePatches.filter(t=>t.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&t.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(p.absences.filter(t=>t.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&t.end>=a.value.startOf("month").toFormat("yyyy-MM-dd")))),E=U(()=>J.value.filter(s=>!r.value||(r.value.selected_users.length==0||r.value.selected_users.includes(s.user_id))&&(r.value.selected_absence_types.length==0||!s.absence_type_id||r.value.selected_absence_types.includes(s.absence_type_id))&&(r.value.selected_statuses.length==0||r.value.selected_statuses.includes(s.status)))),O=v(!1),V=v(!1),F=v(null),x=v(null),N=v(null),j=U(()=>p.users.find(s=>{var t;return s.id===((t=F.value)==null?void 0:t.user_id)})),D=(()=>{var s,t;return route().params.openAbsence?((s=p.absences)==null?void 0:s.find(e=>e.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((t=p.absencePatches)==null?void 0:t.find(e=>e.id==Number(route().params.openAbsencePatch)))??null:null})();D&&(F.value=D,x.value=D.user_id,O.value=!0);function B(s,t){x.value=s;const e=E.value.filter(u=>u.user_id===s).find(u=>t&&d.fromSQL(u.start)<=t&&t<=d.fromSQL(u.end));N.value=t??null,F.value=e??null,e&&["hasOpenPatch","created"].includes(pe(e))?V.value=!0:O.value=!0}function K(){const s=[];for(let t=1;t<=a.value.daysInMonth;t++)s.push(a.value.startOf("month").plus({day:t-1}));return s}function X(){const s=[];for(let t=1;t<=7;t++)s.push(a.value.startOf("week").plus({day:t-1}));return s}const g=v([a.value.toFormat("yyyy-MM")]),$=v(!1),Y=ce(()=>{g.value.includes(a.value.toFormat("yyyy-MM"))||de.reload({only:["absences","absencePatches","holidays","schoolHolidays"],data:{date:a.value.toFormat("yyyy-MM"),openAbsence:null,openAbsencePatch:null},onStart:()=>{g.value.push(a.value.toFormat("yyyy-MM")),$.value=!0},onError:()=>g.value=g.value.filter(s=>s!=a.value.toFormat("yyyy-MM")),onFinish:()=>$.value=!1})},500);z(a,Y);const Z=ye(81),m=te(),L=U(()=>p.schoolHolidays[a.value.toFormat("yyyy-MM")]??{}),R=U(()=>Object.entries(L.value).filter(([s,t])=>{var e,u;return(((e=r.value)==null?void 0:e.selected_holidays.length)==0||((u=r.value)==null?void 0:u.selected_holidays.includes(s)))&&t.length!=0}).flatMap(([s,t])=>[...t].filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))));return(s,t)=>(n(),b(ie,{title:"Abwesenheiten"},{default:y(()=>[O.value&&x.value?(n(),b(fe,{key:0,absence_types:s.absence_types,users:s.users,selectedAbsence:F.value,selectedDate:N.value,selectedUser:x.value,"onUpdate:selectedUser":t[0]||(t[0]=e=>x.value=e),modelValue:O.value,"onUpdate:modelValue":t[1]||(t[1]=e=>O.value=e),onAbsenceReload:t[2]||(t[2]=e=>g.value=[a.value.toFormat("yyyy-MM")])},null,8,["absence_types","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):C("",!0),V.value&&F.value&&j.value?(n(),b(be,{key:1,absence_types:s.absence_types,users:s.users,selectedAbsence:F.value,absenceUser:j.value,modelValue:V.value,"onUpdate:modelValue":t[3]||(t[3]=e=>V.value=e),onAbsenceReload:t[4]||(t[4]=e=>g.value=[a.value.toFormat("yyyy-MM")])},null,8,["absence_types","users","selectedAbsence","absenceUser","modelValue"])):C("",!0),o(se,null,{default:y(()=>[o(ae,{class:"px-sm-4 px-0"},{default:y(()=>[A("div",{class:le(["d-flex align-center w-100",l(m).mdAndUp.value?"justify-space-between":"justify-center"])},[o(me,{absence_types:s.absence_types,users:s.users,user_absence_filters:s.user_absence_filters,filterForm:l(M),"onUpdate:filterForm":t[5]||(t[5]=e=>W(M)?M.value=e:null),singleFilterForm:l(k),"onUpdate:singleFilterForm":t[6]||(t[6]=e=>W(k)?k.value=e:null),schoolHolidays:L.value,federal_state:s.federal_state,all_federal_states:s.all_federal_states},null,8,["absence_types","users","user_absence_filters","filterForm","singleFilterForm","schoolHolidays","federal_state","all_federal_states"]),A("div",_e,[A("div",he,[l(m).mdAndUp.value?(n(),c(_,{key:0},[o(h,{onClick:t[7]||(t[7]=w(e=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:y(()=>[o(S,{icon:"mdi-chevron-double-left"})]),_:1}),o(h,{onClick:t[8]||(t[8]=w(e=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:y(()=>[o(S,{icon:"mdi-chevron-left"})]),_:1})],64)):(n(),b(h,{key:1,onClick:t[9]||(t[9]=w(e=>a.value=a.value.minus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:y(()=>[o(S,{icon:"mdi-chevron-left"})]),_:1}))]),A("h2",{class:"mx-md-4 text-center",style:Q({minWidth:l(m).mdAndUp.value?"170px":"110px"})},[l(m).mdAndUp.value?(n(),c(_,{key:0},[q(I(a.value.toFormat("MMMM yyyy")),1)],64)):(n(),c(_,{key:1},[q(I(a.value.startOf("week").toFormat("dd.MM.yy"))+" - "+I(a.value.endOf("week").toFormat("dd.MM.yy")),1)],64)),$.value?(n(),b(ne,{key:2,indeterminate:""})):C("",!0)],4),A("div",Me,[l(m).mdAndUp.value?(n(),c(_,{key:0},[o(h,{onClick:t[10]||(t[10]=w(e=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:y(()=>[o(S,{icon:"mdi-chevron-right"})]),_:1}),o(h,{onClick:t[11]||(t[11]=w(e=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:y(()=>[o(S,{icon:"mdi-chevron-double-right"})]),_:1})],64)):(n(),b(h,{key:1,onClick:t[12]||(t[12]=w(e=>a.value=a.value.plus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:y(()=>[o(S,{icon:"mdi-chevron-right"})]),_:1}))])]),l(m).mdAndUp.value?(n(),c("div",ke)):C("",!0)],2)]),_:1}),o(oe),o(re,{"fixed-header":"",style:Q([{"white-space":"pre"},{maxHeight:l(Z)}]),id:"absence-table",items:s.users.filter(e=>!r.value||r.value.selected_users.length==0||r.value.selected_users.includes(e.id)).map(e=>({...e,name:l(m).mdAndUp.value?e.last_name+", "+e.first_name:e.first_name.substring(0,1)+"."+e.last_name})).toSorted((e,u)=>u.id==s.$page.props.auth.user.id?1:e.last_name.localeCompare(u.last_name)),headers:[{title:"Name",key:"name",headerProps:{class:"px-sm-4 px-1"}},...l(m).mdAndUp.value?[{title:"",key:"action",width:"48px",sortable:!1}]:[],...(l(m).mdAndUp.value?K():X()).map((e,u,f)=>({title:e.weekdayShort+`
`+e.day.toString(),key:e.toString(),sortable:!1,align:"center",width:1/f.length*100+"%",headerProps:{class:{"bg-blue-darken-2":e.toISODate()===l(d).local().toISODate(),"bg-grey":e.toISODate()!==l(d).local().toISODate()&&R.value.some(i=>{const P=l(d).fromISO(i.start),H=l(d).fromISO(i.end);return e>=P&&e<=H})},title:R.value.filter(i=>{const P=l(d).fromISO(i.start),H=l(d).fromISO(i.end);return e>=P&&e<=H}).map(i=>i.name).join(`
`)}}))]},{item:y(({item:e,columns:u})=>[A("tr",null,[(n(!0),c(_,null,ue(u,f=>(n(),c(_,{key:f.key},[f.key==="name"?(n(),c("td",Fe,I(e.name),1)):f.key==="action"?(n(),c(_,{key:1},[s.can("absence","create",e)?(n(),c("td",ge,[o(h,{icon:"mdi-plus",variant:"text",onClick:i=>s.can("absence","create",e)&&B(e.id)},null,8,["onClick"])])):(n(),c("td",Ae))],64)):(n(),b(ve,{key:2,onClick:i=>s.can("absence","create",e)&&B(e.id,l(d).fromISO(f.key)),holidays:s.holidays,absenceTypes:s.absence_types,user:e,date:l(d).fromISO(f.key),entries:E.value.filter(i=>i.user_id===e.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1})]),_:1}))}});export{De as default};
