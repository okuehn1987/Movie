import{d as ae,r as y,D as i,w as Q,c as w,u as le,a as h,o as n,b as f,e as V,f as r,V as ne,g as oe,h as U,n as re,i as l,j as m,k as q,F as _,l as F,m as S,p as D,q as G,s as J,t as C,v as ue,x as de,y as ie,z as ce,A as ye}from"./app-F2iIgKrU.js";import{A as me}from"./AdminLayout-BEKy7K-t.js";import{t as ve,u as fe}from"./utils-Cj0Lu3rF.js";import{_ as pe}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-B0ff4o9k.js";import{_ as be,g as he}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-DaloTC71.js";import{_ as Me}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-PGfzWKRs.js";import{_ as ke}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang-cCXwfBW1.js";import{_ as _e}from"./ShowHomeOfficeModal.vue_vue_type_script_setup_true_lang-BFg_WryS.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Fe={class:"d-flex flex-wrap align-center"},ge={class:"d-flex"},Oe={class:"d-flex"},Ae={key:0,style:{width:"64px"}},we={key:0,style:{"max-width":"calc(100vw - 28px * 7)","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"},class:"px-sm-4 px-1"},Ue={key:0},Se={key:1},Ee=ae({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absenceTypes:{},holidays:{},schoolHolidays:{},date:{},homeOfficeDays:{},userAbsenceFilters:{},federal_state:{},all_federal_states:{}},setup(K){const v=K,N=route().params.date,a=y(N?i.fromFormat(N,"yyyy-MM"):i.now()),g=useForm({set:null,selected_users:[],selected_absence_types:[],selected_statuses:["created","accepted"],selected_holidays:[v.federal_state]}),O=useForm({set:null,selected_users:[],selected_absence_types:[],selected_statuses:["created","accepted"],selected_holidays:[v.federal_state]}),u=y(O);Q([()=>O.data(),()=>g.set],()=>{g.set==null?u.value=O:u.value=g},{deep:!0});const X=w(()=>v.homeOfficeDays.filter(s=>s.date>=a.value.startOf("month").toFormat("yyyy-MM-dd")&&s.date<=a.value.endOf("month").toFormat("yyyy-MM-dd"))),Y=w(()=>[].concat(v.absencePatches.filter(t=>t.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&t.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(v.absences.filter(t=>t.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&t.end>=a.value.startOf("month").toFormat("yyyy-MM-dd")))),j=w(()=>Y.value.filter(s=>!u.value||(u.value.selected_users.length==0||u.value.selected_users.includes(s.user_id))&&(u.value.selected_absence_types.length==0||!s.absence_type_id||u.value.selected_absence_types.includes(s.absence_type_id))&&(u.value.selected_statuses.length==0||u.value.selected_statuses.includes(s.status)))),A=y(!1),T=y(!1),x=y(!1),M=y(null),$=y(null),b=y(null),B=y(null),L=w(()=>v.users.find(s=>{var t;return s.id===((t=M.value)==null?void 0:t.user_id)})),I=(()=>{var s,t;return route().params.openAbsence?((s=v.absences)==null?void 0:s.find(e=>e.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((t=v.absencePatches)==null?void 0:t.find(e=>e.id==Number(route().params.openAbsencePatch)))??null:null})();I&&(M.value=I,b.value=I.user_id,A.value=!0);function R(s,t){b.value=s,B.value=t??null;const e=j.value.filter(o=>o.user_id===s).find(o=>t&&i.fromSQL(o.start)<=t&&t<=i.fromSQL(o.end));if(e)M.value=e??null,["hasOpenPatch","created"].includes(he(e))?T.value=!0:A.value=!0;else{M.value=null;const o=v.homeOfficeDays.filter(c=>c.user_id===s).find(c=>t&&c.date===t.toFormat("yyyy-MM-dd"));$.value=o??null,o?x.value=!0:A.value=!0}}function Z(){const s=[];for(let t=1;t<=a.value.daysInMonth;t++)s.push(a.value.startOf("month").plus({day:t-1}));return s}function ee(){const s=[];for(let t=1;t<=7;t++)s.push(a.value.startOf("week").plus({day:t-1}));return s}const k=y([a.value.toFormat("yyyy-MM")]),H=y(!1),te=ve(()=>{k.value.includes(a.value.toFormat("yyyy-MM"))||ye.reload({only:["absences","absencePatches","holidays","homeOfficeDays","schoolHolidays"],data:{date:a.value.toFormat("yyyy-MM"),openAbsence:null,openAbsencePatch:null},onStart:()=>{k.value.push(a.value.toFormat("yyyy-MM")),H.value=!0},onError:()=>k.value=k.value.filter(s=>s!=a.value.toFormat("yyyy-MM")),onFinish:()=>H.value=!1})},500);Q(a,te);const se=fe(81),p=le(),z=w(()=>v.schoolHolidays[a.value.toFormat("yyyy-MM")]??{}),W=w(()=>Object.entries(z.value).filter(([s,t])=>{var e,o;return(((e=u.value)==null?void 0:e.selected_holidays.length)==0||((o=u.value)==null?void 0:o.selected_holidays.includes(s)))&&t.length!=0}).flatMap(([s,t])=>[...t].filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))));return(s,t)=>(n(),h(me,{title:"Abwesenheiten"},{default:f(()=>[A.value&&b.value?(n(),h(Me,{key:0,absenceTypes:s.absenceTypes,users:s.users,selectedAbsence:M.value,selectedDate:B.value,selectedUser:b.value,"onUpdate:selectedUser":t[0]||(t[0]=e=>b.value=e),modelValue:A.value,"onUpdate:modelValue":t[1]||(t[1]=e=>A.value=e),onAbsenceReload:t[2]||(t[2]=e=>k.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):V("",!0),T.value&&M.value&&L.value?(n(),h(ke,{key:1,absenceTypes:s.absenceTypes,users:s.users,selectedAbsence:M.value,absenceUser:L.value,modelValue:T.value,"onUpdate:modelValue":t[3]||(t[3]=e=>T.value=e),onAbsenceReload:t[4]||(t[4]=e=>k.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","absenceUser","modelValue"])):V("",!0),x.value&&b.value&&$.value?(n(),h(_e,{key:2,selectedHomeOffice:$.value,users:s.users,selectedUser:b.value,"onUpdate:selectedUser":t[5]||(t[5]=e=>b.value=e),modelValue:x.value,"onUpdate:modelValue":t[6]||(t[6]=e=>x.value=e),onHomeOfficeReload:t[7]||(t[7]=e=>k.value=[a.value.toFormat("yyyy-MM")])},null,8,["selectedHomeOffice","users","selectedUser","modelValue"])):V("",!0),r(ne,null,{default:f(()=>[r(oe,{class:"px-sm-4 px-0"},{default:f(()=>[U("div",{class:re(["d-flex align-center w-100",l(p).mdAndUp.value?"justify-space-between":"justify-center"])},[r(pe,{absenceTypes:s.absenceTypes,users:s.users,userAbsenceFilters:s.userAbsenceFilters,filterForm:l(g),"onUpdate:filterForm":t[8]||(t[8]=e=>q(g)?g.value=e:null),singleFilterForm:l(O),"onUpdate:singleFilterForm":t[9]||(t[9]=e=>q(O)?O.value=e:null),schoolHolidays:z.value,federal_state:s.federal_state,all_federal_states:s.all_federal_states},null,8,["absenceTypes","users","userAbsenceFilters","filterForm","singleFilterForm","schoolHolidays","federal_state","all_federal_states"]),U("div",Fe,[U("div",ge,[l(p).mdAndUp.value?(n(),m(_,{key:0},[r(F,{onClick:t[10]||(t[10]=S(e=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:f(()=>[r(D,{icon:"mdi-chevron-double-left"})]),_:1}),r(F,{onClick:t[11]||(t[11]=S(e=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:f(()=>[r(D,{icon:"mdi-chevron-left"})]),_:1})],64)):(n(),h(F,{key:1,onClick:t[12]||(t[12]=S(e=>a.value=a.value.minus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:f(()=>[r(D,{icon:"mdi-chevron-left"})]),_:1}))]),U("h2",{class:"mx-md-4 text-center",style:G({minWidth:l(p).mdAndUp.value?"170px":"110px"})},[l(p).mdAndUp.value?(n(),m(_,{key:0},[J(C(a.value.toFormat("MMMM yyyy")),1)],64)):(n(),m(_,{key:1},[J(C(a.value.startOf("week").toFormat("dd.MM.yy"))+" - "+C(a.value.endOf("week").toFormat("dd.MM.yy")),1)],64)),H.value?(n(),h(ue,{key:2,indeterminate:""})):V("",!0)],4),U("div",Oe,[l(p).mdAndUp.value?(n(),m(_,{key:0},[r(F,{onClick:t[13]||(t[13]=S(e=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:f(()=>[r(D,{icon:"mdi-chevron-right"})]),_:1}),r(F,{onClick:t[14]||(t[14]=S(e=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:f(()=>[r(D,{icon:"mdi-chevron-double-right"})]),_:1})],64)):(n(),h(F,{key:1,onClick:t[15]||(t[15]=S(e=>a.value=a.value.plus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:f(()=>[r(D,{icon:"mdi-chevron-right"})]),_:1}))])]),l(p).mdAndUp.value?(n(),m("div",Ae)):V("",!0)],2)]),_:1}),r(de),r(ie,{"fixed-header":"",style:G([{"white-space":"pre"},{maxHeight:l(se)}]),id:"absence-table",items:s.users.filter(e=>!u.value||u.value.selected_users.length==0||u.value.selected_users.includes(e.id)).map(e=>({...e,name:l(p).mdAndUp.value?e.last_name+", "+e.first_name:e.first_name.substring(0,1)+"."+e.last_name})).toSorted((e,o)=>o.id==s.$page.props.auth.user.id?1:e.id==s.$page.props.auth.user.id?-1:e.last_name.localeCompare(o.last_name)),headers:[{title:"Name",key:"name",headerProps:{class:"px-sm-4 px-1"}},...l(p).mdAndUp.value?[{title:"",key:"action",width:"48px",sortable:!1}]:[],...(l(p).mdAndUp.value?Z():ee()).map((e,o,c)=>({title:e.weekdayShort+`
`+e.day.toString(),key:e.toString(),sortable:!1,align:"center",width:1/c.length*100+"%",headerProps:{class:{"bg-blue-darken-2":e.toISODate()===l(i).local().toISODate(),"bg-grey":e.toISODate()!==l(i).local().toISODate()&&W.value.some(d=>{const P=l(i).fromISO(d.start),E=l(i).fromISO(d.end);return e>=P&&e<=E})},title:W.value.filter(d=>{const P=l(i).fromISO(d.start),E=l(i).fromISO(d.end);return e>=P&&e<=E}).map(d=>d.name).join(`
`)}}))]},{item:f(({item:e,columns:o})=>[U("tr",null,[(n(!0),m(_,null,ce(o,c=>(n(),m(_,{key:c.key},[c.key==="name"?(n(),m("td",we,C(e.name),1)):c.key==="action"?(n(),m(_,{key:1},[s.can("absence","create",e)?(n(),m("td",Ue,[r(F,{icon:"mdi-plus",variant:"text",onClick:d=>s.can("absence","create",e)&&R(e.id)},null,8,["onClick"])])):(n(),m("td",Se))],64)):(n(),h(be,{key:2,onClick:d=>s.can("absence","create",e)&&R(e.id,l(i).fromISO(c.key)),holidays:s.holidays,absenceTypes:s.absenceTypes,user:e,date:l(i).fromISO(c.key),entries:j.value.filter(d=>d.user_id===e.id),homeOfficeDays:X.value.filter(d=>d.user_id===e.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries","homeOfficeDays"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1})]),_:1}))}});export{Ee as default};
