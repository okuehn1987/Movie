import{d as ae,r as y,D as i,w as W,c as S,u as le,a as h,o as n,b as v,e as V,f as u,V as ne,g as oe,h as w,n as re,i as l,j as m,k as Q,F as g,l as k,m as U,p as D,q,s as J,t as $,v as ue,x as de,y as ie,z as ce,A as ye}from"./app-C0jDoDpN.js";import{A as me}from"./AdminLayout-go9j7Izp.js";import{t as fe,u as ve}from"./utils-CsW4Aq0T.js";import{_ as pe}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-CF7DpLGY.js";import{_ as be,g as he}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-D6uKcvyr.js";import{_ as _e}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-CZD652kG.js";import{_ as Me}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang-CSxPsJ4X.js";import{_ as ge}from"./ShowHomeOfficeModal.vue_vue_type_script_setup_true_lang-BNHC5MRE.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ke={class:"d-flex flex-wrap align-center"},Fe={class:"d-flex"},Oe={class:"d-flex"},Ae={key:0,style:{width:"64px"}},Se={key:0,style:{"max-width":"calc(100vw - 28px * 7)","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"},class:"px-sm-4 px-1"},we={key:0},Ue={key:1},Ee=ae({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absenceTypes:{},holidays:{},schoolHolidays:{},date:{},homeOfficeDays:{},userAbsenceFilters:{},federal_state:{},all_federal_states:{},filterableOperatingSites:{},filterableGroups:{}},setup(K){const f=K,N=route().params.date,a=y(N?i.fromFormat(N,"yyyy-MM"):i.now()),F=useForm({set:null,selected_users:[],selected_absence_types:[],selected_operating_sites:[],selected_groups:[],selected_statuses:["created","accepted"],selected_holidays:[f.federal_state]}),O=useForm({set:null,selected_users:[],selected_absence_types:[],selected_operating_sites:[],selected_groups:[],selected_statuses:["created","accepted"],selected_holidays:[f.federal_state]}),o=y(O);W([()=>O.data(),()=>F.set],()=>{F.set==null?o.value=O:o.value=F},{deep:!0});const X=S(()=>f.homeOfficeDays.filter(s=>s.date>=a.value.startOf("month").toFormat("yyyy-MM-dd")&&s.date<=a.value.endOf("month").toFormat("yyyy-MM-dd"))),Y=S(()=>[].concat(f.absencePatches.filter(t=>t.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&t.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(f.absences.filter(t=>t.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&t.end>=a.value.startOf("month").toFormat("yyyy-MM-dd")))),j=S(()=>Y.value.filter(s=>!o.value||(o.value.selected_users.length==0||o.value.selected_users.includes(s.user_id))&&(o.value.selected_absence_types.length==0||!s.absence_type_id||o.value.selected_absence_types.includes(s.absence_type_id))&&(o.value.selected_statuses.length==0||o.value.selected_statuses.includes(s.status)))),A=y(!1),T=y(!1),C=y(!1),_=y(null),x=y(null),b=y(null),B=y(null),L=S(()=>f.users.find(s=>{var t;return s.id===((t=_.value)==null?void 0:t.user_id)})),I=(()=>{var s,t;return route().params.openAbsence?((s=f.absences)==null?void 0:s.find(e=>e.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((t=f.absencePatches)==null?void 0:t.find(e=>e.id==Number(route().params.openAbsencePatch)))??null:null})();I&&(_.value=I,b.value=I.user_id,A.value=!0);function R(s,t){b.value=s,B.value=t??null;const e=j.value.filter(r=>r.user_id===s).find(r=>t&&i.fromSQL(r.start)<=t&&t<=i.fromSQL(r.end));if(e)_.value=e??null,["hasOpenPatch","created"].includes(he(e))?T.value=!0:A.value=!0;else{_.value=null;const r=f.homeOfficeDays.filter(c=>c.user_id===s).find(c=>t&&c.date===t.toFormat("yyyy-MM-dd"));x.value=r??null,r?C.value=!0:A.value=!0}}function Z(){const s=[];for(let t=1;t<=a.value.daysInMonth;t++)s.push(a.value.startOf("month").plus({day:t-1}));return s}function ee(){const s=[];for(let t=1;t<=7;t++)s.push(a.value.startOf("week").plus({day:t-1}));return s}const M=y([a.value.toFormat("yyyy-MM")]),H=y(!1),te=fe(()=>{M.value.includes(a.value.toFormat("yyyy-MM"))||ye.reload({only:["absences","absencePatches","holidays","homeOfficeDays","schoolHolidays"],data:{date:a.value.toFormat("yyyy-MM"),openAbsence:null,openAbsencePatch:null},onStart:()=>{M.value.push(a.value.toFormat("yyyy-MM")),H.value=!0},onError:()=>M.value=M.value.filter(s=>s!=a.value.toFormat("yyyy-MM")),onFinish:()=>H.value=!1})},500);W(a,te);const se=ve(81),p=le(),G=S(()=>f.schoolHolidays[a.value.toFormat("yyyy-MM")]??{}),z=S(()=>Object.entries(G.value).filter(([s,t])=>{var e,r;return(((e=o.value)==null?void 0:e.selected_holidays.length)==0||((r=o.value)==null?void 0:r.selected_holidays.includes(s)))&&t.length!=0}).flatMap(([s,t])=>[...t].filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))));return(s,t)=>(n(),h(me,{title:"Abwesenheiten"},{default:v(()=>[A.value&&b.value?(n(),h(_e,{key:0,absenceTypes:s.absenceTypes,users:s.users,selectedAbsence:_.value,selectedDate:B.value,selectedUser:b.value,"onUpdate:selectedUser":t[0]||(t[0]=e=>b.value=e),modelValue:A.value,"onUpdate:modelValue":t[1]||(t[1]=e=>A.value=e),onAbsenceReload:t[2]||(t[2]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):V("",!0),T.value&&_.value&&L.value?(n(),h(Me,{key:1,absenceTypes:s.absenceTypes,users:s.users,selectedAbsence:_.value,absenceUser:L.value,modelValue:T.value,"onUpdate:modelValue":t[3]||(t[3]=e=>T.value=e),onAbsenceReload:t[4]||(t[4]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","absenceUser","modelValue"])):V("",!0),C.value&&b.value&&x.value?(n(),h(ge,{key:2,selectedHomeOffice:x.value,users:s.users,selectedUser:b.value,"onUpdate:selectedUser":t[5]||(t[5]=e=>b.value=e),modelValue:C.value,"onUpdate:modelValue":t[6]||(t[6]=e=>C.value=e),onHomeOfficeReload:t[7]||(t[7]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["selectedHomeOffice","users","selectedUser","modelValue"])):V("",!0),u(ne,null,{default:v(()=>[u(oe,{class:"px-sm-4 px-0"},{default:v(()=>[w("div",{class:re(["d-flex align-center w-100",l(p).mdAndUp.value?"justify-space-between":"justify-center"])},[u(pe,{absenceTypes:s.absenceTypes,users:s.users,userAbsenceFilters:s.userAbsenceFilters,filterForm:l(F),"onUpdate:filterForm":t[8]||(t[8]=e=>Q(F)?F.value=e:null),singleFilterForm:l(O),"onUpdate:singleFilterForm":t[9]||(t[9]=e=>Q(O)?O.value=e:null),schoolHolidays:G.value,federal_state:s.federal_state,all_federal_states:s.all_federal_states,filterableOperatingSites:s.filterableOperatingSites,filterableGroups:s.filterableGroups},null,8,["absenceTypes","users","userAbsenceFilters","filterForm","singleFilterForm","schoolHolidays","federal_state","all_federal_states","filterableOperatingSites","filterableGroups"]),w("div",ke,[w("div",Fe,[l(p).mdAndUp.value?(n(),m(g,{key:0},[u(k,{onClick:t[10]||(t[10]=U(e=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:v(()=>[u(D,{icon:"mdi-chevron-double-left"})]),_:1}),u(k,{onClick:t[11]||(t[11]=U(e=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:v(()=>[u(D,{icon:"mdi-chevron-left"})]),_:1})],64)):(n(),h(k,{key:1,onClick:t[12]||(t[12]=U(e=>a.value=a.value.minus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:v(()=>[u(D,{icon:"mdi-chevron-left"})]),_:1}))]),w("h2",{class:"mx-md-4 text-center",style:q({minWidth:l(p).mdAndUp.value?"170px":"110px"})},[l(p).mdAndUp.value?(n(),m(g,{key:0},[J($(a.value.toFormat("MMMM yyyy")),1)],64)):(n(),m(g,{key:1},[J($(a.value.startOf("week").toFormat("dd.MM.yy"))+" - "+$(a.value.endOf("week").toFormat("dd.MM.yy")),1)],64)),H.value?(n(),h(ue,{key:2,indeterminate:""})):V("",!0)],4),w("div",Oe,[l(p).mdAndUp.value?(n(),m(g,{key:0},[u(k,{onClick:t[13]||(t[13]=U(e=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:v(()=>[u(D,{icon:"mdi-chevron-right"})]),_:1}),u(k,{onClick:t[14]||(t[14]=U(e=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:v(()=>[u(D,{icon:"mdi-chevron-double-right"})]),_:1})],64)):(n(),h(k,{key:1,onClick:t[15]||(t[15]=U(e=>a.value=a.value.plus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:v(()=>[u(D,{icon:"mdi-chevron-right"})]),_:1}))])]),l(p).mdAndUp.value?(n(),m("div",Ae)):V("",!0)],2)]),_:1}),u(de),u(ie,{"fixed-header":"",style:q([{"white-space":"pre"},{maxHeight:l(se)}]),id:"absence-table",items:s.users.filter(e=>!o.value||(o.value.selected_users.length==0||o.value.selected_users.includes(e.id))&&(o.value.selected_operating_sites.length==0||o.value.selected_operating_sites.includes(e.operating_site_id))&&(o.value.selected_groups.length==0||e.group_id&&o.value.selected_groups.includes(e.group_id))).map(e=>({...e,name:l(p).mdAndUp.value?e.last_name+", "+e.first_name:e.first_name.substring(0,1)+"."+e.last_name})).toSorted((e,r)=>r.id==s.$page.props.auth.user.id?1:e.id==s.$page.props.auth.user.id?-1:e.last_name.localeCompare(r.last_name)),headers:[{title:"Name",key:"name",headerProps:{class:"px-sm-4 px-1"}},...l(p).mdAndUp.value?[{title:"",key:"action",width:"48px",sortable:!1}]:[],...(l(p).mdAndUp.value?Z():ee()).map((e,r,c)=>({title:e.weekdayShort+`
`+e.day.toString(),key:e.toString(),sortable:!1,align:"center",width:1/c.length*100+"%",headerProps:{class:{"bg-blue-darken-2":e.toISODate()===l(i).local().toISODate(),"bg-grey":e.toISODate()!==l(i).local().toISODate()&&z.value.some(d=>{const P=l(i).fromISO(d.start),E=l(i).fromISO(d.end);return e>=P&&e<=E})},title:z.value.filter(d=>{const P=l(i).fromISO(d.start),E=l(i).fromISO(d.end);return e>=P&&e<=E}).map(d=>d.name).join(`
`)}}))]},{item:v(({item:e,columns:r})=>[w("tr",null,[(n(!0),m(g,null,ce(r,c=>(n(),m(g,{key:c.key},[c.key==="name"?(n(),m("td",Se,$(e.name),1)):c.key==="action"?(n(),m(g,{key:1},[s.can("absence","create",e)?(n(),m("td",we,[u(k,{icon:"mdi-plus",variant:"text",onClick:d=>s.can("absence","create",e)&&R(e.id)},null,8,["onClick"])])):(n(),m("td",Ue))],64)):(n(),h(be,{key:2,onClick:d=>s.can("absence","create",e)&&R(e.id,l(i).fromISO(c.key)),holidays:s.holidays,absenceTypes:s.absenceTypes,user:e,date:l(i).fromISO(c.key),entries:j.value.filter(d=>d.user_id===e.id),homeOfficeDays:X.value.filter(d=>d.user_id===e.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries","homeOfficeDays"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1})]),_:1}))}});export{Ee as default};
