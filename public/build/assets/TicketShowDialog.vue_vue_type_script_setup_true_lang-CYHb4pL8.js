import{d as I,D as v,w as Q,r as O,c as F,a as p,o as d,Q as q,b as s,f as o,V as j,x as K,h as W,K as R,e as w,L as c,O as C,M as G,g as a,a9 as J,a5 as Z,a6 as X,p as f,s as u,t as y,N as Y,ap as x,i as l,P as B,an as ee,a0 as te,y as M,l as g,aq as ie,j as h,F as N,ar as se,z as oe,m as S,J as ae,A as L,n as re}from"./app-BEVyWQGH.js";import{_ as P}from"./ConfirmDelete.vue_vue_type_script_setup_true_lang-CTeij4SS.js";import{D as le,P as ne}from"./types-BVvW7sCV.js";import{c as D}from"./utils-DpGD7wvb.js";import{_ as de}from"./RecordCreateDialog.vue_vue_type_script_setup_true_lang-CTsfJ-AM.js";const ue={class:"d-flex"},me={class:"d-flex ga-2"},ce=["colspan"],pe={class:"bg-surface-medium"},ke={class:"bg-surface-light"},fe={class:"py-2"},ge={style:{font:"unset"}},ye={class:"py-2"},be={style:{font:"unset"}},we={key:0,style:{width:"1px"}},he={key:1},Ve={class:"py-2"},ve={style:{width:"1px",padding:"0"}},Te={style:{width:"1px",padding:"0"}},Re=I({__name:"TicketShowDialog",props:{ticket:{},customers:{},users:{},tab:{},operatingSites:{}},setup(U){const n=U,r=useForm({priority:n.ticket.priority,assignees:n.ticket.assignees.map(e=>e.id),title:n.ticket.title,description:n.ticket.description,selected:n.ticket.records.filter(e=>e.accounted_at).map(e=>e.id),appointment_at:n.ticket.appointment_at?v.fromSQL(n.ticket.appointment_at).toFormat(le):null,files:[]});Q(()=>n.ticket,()=>{r.defaults({priority:n.ticket.priority,assignees:n.ticket.assignees.map(e=>e.id)??[],title:n.ticket.title,description:n.ticket.description,selected:n.ticket.records.filter(e=>e.accounted_at).map(e=>e.id)}).reset()},{deep:!0});const T=O(Number(route().params.openTicket)==n.ticket.id),_=F(()=>n.ticket.records.length>0),$=F(()=>n.ticket.records.reduce((e,t)=>e+t.duration,0)),z=F(()=>n.ticket.records.filter(e=>r.selected.find(t=>t===e.id)).reduce((e,t)=>e+t.duration,0)),E={accepted:"mdi-check",created:"mdi-timer-sand",declined:"mdi-close"};function A(){var e;if(route().current()==="ticket.show")L.get(route("ticket.index",{tab:n.tab}));else{const t=(e=route().routeParams)==null?void 0:e.customer;t?L.get(route("customer.show",{customer:t,tab:n.tab})):T.value=!1}}function H(e){navigator.clipboard.writeText(v.fromSQL(e.start).toFormat("dd.MM.yyyy HH:mm")+" - "+v.fromSQL(e.start).plus({seconds:e.duration}).toFormat("HH:mm")+" Uhr, "+e.userName+`

`+(e.description??""))}return(e,t)=>(d(),p(q,{"max-width":"1000px",height:"800px",modelValue:T.value,"onUpdate:modelValue":t[6]||(t[6]=b=>T.value=b)},{activator:s(({props:b})=>[o(g,B({title:"Auftrag anzeigen"},b,{icon:"",variant:"text"}),{default:s(()=>[o(f,{icon:"mdi-eye"})]),_:1},16)]),default:s(({isActive:b})=>[o(ae,{onSubmit:S(i=>{a(r).patch(e.route("ticket.update",{ticket:e.ticket.id}),{onSuccess:()=>{a(r).reset(),b.value=!1,A()}})},["prevent"])},{default:s(()=>[o(j,{title:"Auftrag anzeigen"},{append:s(()=>[o(g,{icon:"",variant:"text",onClick:S(i=>{b.value=!1,A()},["stop"])},{default:s(()=>[o(f,null,{default:s(()=>[...t[7]||(t[7]=[u("mdi-close",-1)])]),_:1})]),_:1},8,["onClick"])]),default:s(()=>[o(K),o(W,null,{default:s(()=>[o(R,null,{default:s(()=>[o(c,{cols:"12",md:"8"},{default:s(()=>[o(C,{label:"Kunde","model-value":e.ticket.customer.name,disabled:""},null,8,["model-value"])]),_:1}),o(c,{cols:"12",md:"4"},{default:s(()=>[o(G,{items:a(ne),label:"Priorität",required:"","error-messages":a(r).errors.priority,modelValue:a(r).priority,"onUpdate:modelValue":t[0]||(t[0]=i=>a(r).priority=i),disabled:e.tab!=="newTickets"},{selection:s(({item:i})=>[u(y(i.raw.title)+" ",1),o(f,{class:"ms-2",icon:i.raw.icon,color:i.raw.color},null,8,["icon","color"])]),item:s(({props:i,item:m})=>[o(J,Z(X(i)),{append:s(()=>[o(f,{icon:m.raw.icon,color:m.raw.color},null,8,["icon","color"])]),_:2},1040)]),_:1},8,["items","error-messages","modelValue","disabled"])]),_:1}),o(c,{cols:"12",md:"12"},{default:s(()=>[o(Y,{label:"Zuweisung",disabled:e.tab!=="newTickets"&&e.tab!=="workingTickets",required:"",multiple:"",chips:"",modelValue:a(r).assignees,"onUpdate:modelValue":t[1]||(t[1]=i=>a(r).assignees=i),"error-messages":a(r).errors.assignees,items:e.users.map(i=>({value:i.id,title:`${i.first_name} ${i.last_name}`,props:{subtitle:i.job_role??""}}))},{chip:s(({item:i})=>{var m;return[o(ee,{"prepend-icon":E[((m=e.ticket.assignees.find(k=>k.id===i.value))==null?void 0:m.pivot.status)??"created"]},null,8,["prepend-icon"])]}),append:s(()=>[o(x,null,{activator:s(({props:i})=>[o(f,B(i,{icon:"mdi-information-outline",variant:"text",color:"primary"}),null,16)]),default:s(()=>[o(f,null,{default:s(()=>[...t[8]||(t[8]=[u("mdi-check",-1)])]),_:1}),t[11]||(t[11]=u(" : angenommen ",-1)),t[12]||(t[12]=l("br",null,null,-1)),o(f,null,{default:s(()=>[...t[9]||(t[9]=[u("mdi-timer-sand",-1)])]),_:1}),t[13]||(t[13]=u(" : zugewiesen ",-1)),t[14]||(t[14]=l("br",null,null,-1)),o(f,null,{default:s(()=>[...t[10]||(t[10]=[u("mdi-close",-1)])]),_:1}),t[15]||(t[15]=u(" : abgelehnt ",-1))]),_:1})]),_:1},8,["disabled","modelValue","error-messages","items"])]),_:1}),o(c,{cols:"12",md:"9"},{default:s(()=>[o(C,{label:"Betreff",modelValue:a(r).title,"onUpdate:modelValue":t[2]||(t[2]=i=>a(r).title=i),readonly:e.tab==="finishedTickets"||e.tab==="archive","error-messages":a(r).errors.title},null,8,["modelValue","readonly","error-messages"])]),_:1}),o(c,{cols:"12",md:"3"},{default:s(()=>[o(C,{type:"datetime-local",label:"Termin",modelValue:a(r).appointment_at,"onUpdate:modelValue":t[3]||(t[3]=i=>a(r).appointment_at=i),errorMessages:a(r).errors.appointment_at,readonly:e.tab!=="newTickets"&&e.tab!=="workingTickets"},null,8,["modelValue","errorMessages","readonly"])]),_:1}),o(c,{cols:"12"},{default:s(()=>[o(te,{label:"Beschreibung",modelValue:a(r).description,"onUpdate:modelValue":t[4]||(t[4]=i=>a(r).description=i),readonly:e.tab==="finishedTickets"||e.tab==="archive","max-rows":"11","auto-grow":"","error-messages":a(r).errors.description},null,8,["modelValue","readonly","error-messages"])]),_:1}),e.ticket.files.length>0?(d(),p(c,{key:0,cols:"12"},{default:s(()=>[o(M,{items:e.ticket.files,headers:[{title:"Anhang",value:"original_name"},{title:"",value:"actions",width:"1px"}]},{"item.actions":s(({item:i})=>[l("div",ue,[i.original_name.endsWith(".pdf")?(d(),p(g,{key:0,variant:"text",href:e.route("ticketFile.show",{ticketFile:i.id}),color:"primary",icon:"mdi-eye"},null,8,["href"])):(d(),p(g,{key:1,variant:"text",href:e.route("ticketFile.getContent",{ticketFile:i.id}),color:"primary",icon:"mdi-download",download:i.original_name},null,8,["href","download"])),o(P,{title:"Datei löschen",content:"Bist du dir sicher, dass du diese Datei löschen möchtest?",route:e.route("ticketFile.destroy",{ticketFile:i.id})},null,8,["route"])])]),_:1},8,["items"])]),_:1})):w("",!0),_.value?(d(),p(M,{key:1,modelValue:a(r).selected,"onUpdate:modelValue":t[5]||(t[5]=i=>a(r).selected=i),headers:[{title:"Start",key:"start"},{title:"Auftragsdauer",key:"duration"},{title:"Erstellt von",key:"userName"},{title:"",key:"actions",width:"1px",sortable:!1}],items:e.ticket.records.map(i=>({...i,userName:i.user.first_name+" "+i.user.last_name})),"show-expand":"","show-select":e.tab!=="archive"&&e.can("ticket","account",e.ticket)},ie({"item.start":s(({item:i})=>[u(y(a(v).fromSQL(i.start).toFormat("dd.MM.yyyy HH:mm")),1)]),"item.duration":s(({item:i})=>[u(y(a(D)(i.duration,"minutes","duration")),1)]),"item.actions":s(({item:i})=>[l("div",me,[o(g,{variant:"text",color:"primary",title:"Eintrag kopieren",onClick:S(m=>H(i),["stop"])},{default:s(()=>[o(f,{icon:"mdi-content-copy"})]),_:1},8,["onClick"]),e.tab!="finishedTickets"&&e.tab!=="archive"?(d(),p(de,{key:0,ticket:e.ticket,users:e.users,record:i,operatingSites:e.operatingSites},null,8,["ticket","users","record","operatingSites"])):w("",!0)])]),"item.data-table-expand":s(({internalItem:i,isExpanded:m,toggleExpand:k})=>[o(g,{size:"small",variant:"text",border:"",onClick:V=>k(i)},{default:s(()=>[o(f,{icon:m(i)?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])]),_:2},1032,["onClick"])]),"expanded-row":s(({columns:i,item:m})=>[l("tr",null,[l("td",{colspan:i.length,class:"py-2"},[o(se,{density:"compact"},{default:s(()=>[l("tbody",pe,[l("tr",ke,[t[16]||(t[16]=l("th",{style:{width:"1px"}},"Ressourcen",-1)),l("td",fe,[l("pre",ge,y(m.resources),1)]),t[17]||(t[17]=l("td",null,null,-1)),t[18]||(t[18]=l("td",null,null,-1))]),l("tr",null,[t[19]||(t[19]=l("th",{style:{width:"1px"}},"Beschreibung",-1)),l("td",ye,[l("pre",be,y(m.description),1)]),t[20]||(t[20]=l("td",null,null,-1)),t[21]||(t[21]=l("td",null,null,-1))]),(d(!0),h(N,null,oe(m.files,(k,V)=>(d(),h("tr",{class:re({"bg-surface-light":V%2==0}),key:V},[V==0?(d(),h("th",we,"Anhang")):(d(),h("th",he)),l("td",Ve,y(k.original_name),1),l("td",ve,[k.original_name.endsWith(".pdf")?(d(),p(g,{key:0,variant:"text",href:e.route("ticketRecordFile.show",{ticketRecordFile:k.id}),color:"primary",icon:"mdi-eye"},null,8,["href"])):(d(),p(g,{key:1,variant:"text",href:e.route("ticketRecordFile.getContent",{ticketRecordFile:k.id}),color:"primary",icon:"mdi-download",download:k.original_name},null,8,["href","download"]))]),l("td",Te,[o(P,{title:"Datei löschen",content:"Bist du dir sicher, dass du diese Datei löschen möchtest?",route:e.route("ticketRecordFile.destroy",{ticketRecordFile:k.id})},null,8,["route"])])],2))),128))])]),_:2},1024)],8,ce)])]),_:2},[e.tab!=="archive"&&e.can("ticket","account",e.ticket)?{name:"bottom",fn:s(()=>[o(R,{class:"text-end","no-gutters":""},{default:s(()=>[(d(),h(N,{key:0},[o(c,{cols:"12",md:"11"},{default:s(()=>[...t[22]||(t[22]=[u("Ausgewählte Auftragsdauer",-1)])]),_:1}),o(c,{cols:"12",md:"1"},{default:s(()=>[u(y(a(D)(z.value,"minutes","duration")),1)]),_:1})],64)),o(c,{cols:"12",md:"11"},{default:s(()=>[...t[23]||(t[23]=[u("Gesamte Auftragsdauer",-1)])]),_:1}),o(c,{cols:"12",md:"1"},{default:s(()=>[u(y(a(D)($.value,"minutes","duration")),1)]),_:1})]),_:1})]),key:"0"}:void 0]),1032,["modelValue","items","show-select"])):w("",!0),e.tab!=="archive"?(d(),p(c,{key:2,cols:"12",class:"text-end"},{default:s(()=>[e.can("ticket","account",e.ticket)?(d(),p(g,{key:0,color:"primary",type:"submit",loading:a(r).processing,disabled:!a(r).isDirty},{default:s(()=>[u(y(e.tab==="newTickets"?"Änderungen und Abrechnungen speichern":"Abrechnungen speichern"),1)]),_:1},8,["loading","disabled"])):["newTickets","workingTickets"].includes(e.tab)?(d(),p(g,{key:1,color:"primary",type:"submit",loading:a(r).processing,disabled:!a(r).isDirty},{default:s(()=>[...t[24]||(t[24]=[u(" Änderungen speichern ",-1)])]),_:1},8,["loading","disabled"])):w("",!0)]),_:1})):w("",!0)]),_:1})]),_:1})]),_:2},1024)]),_:2},1032,["onSubmit"])]),_:1},8,["modelValue"]))}});export{Re as _};
