import{d as le,r as m,D as i,w as W,c as w,u as ne,a as h,o as n,b as p,e as V,f as u,V as oe,n as Q,g as l,h as re,i as S,j as f,k as q,F as g,l as k,m as U,p as D,q as J,s as K,t as I,v as ue,x as de,y as ie,z as ce,A as ye}from"./app-D7dl_JAA.js";import{A as me}from"./AdminLayout-Cs33-4Ip.js";import{t as fe,u as ve}from"./utils-DGeuCjju.js";import{_ as pe}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-iRTVO6Hb.js";import{_ as be,g as he}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-D6D5mSi6.js";import{_ as _e}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-BqJXTp1Q.js";import{_ as Me}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang-BCLJy_en.js";import{_ as ge}from"./ShowHomeOfficeModal.vue_vue_type_script_setup_true_lang-CVZgV4VL.js";import"./ChatDetails-BHssG7eQ.js";import"./ChatMessage-CE-1nMPs.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ke={class:"d-flex flex-wrap align-center"},Fe={class:"d-flex"},Oe={class:"d-flex"},Ae={key:0,style:{width:"64px"}},we={key:0,style:{"max-width":"calc(100vw - 28px * 7)","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"},class:"px-sm-4 px-1"},Se={key:0},Ue={key:1},je=le({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absenceTypes:{},holidays:{},schoolHolidays:{},date:{},homeOfficeDays:{},userAbsenceFilters:{},federal_state:{},all_federal_states:{},filterableOperatingSites:{},filterableGroups:{}},setup(X){const v=X,N=route().params.date,a=m(N?i.fromFormat(N,"yyyy-MM"):i.now()),F=useForm({set:null,selected_users:[],selected_absence_types:[],selected_operating_sites:[],selected_groups:[],selected_statuses:["created","accepted"],selected_holidays:[v.federal_state]}),O=useForm({set:null,selected_users:[],selected_absence_types:[],selected_operating_sites:[],selected_groups:[],selected_statuses:["created","accepted"],selected_holidays:[v.federal_state]}),o=m(O);W([()=>O.data(),()=>F.set],()=>{F.set==null?o.value=O:o.value=F},{deep:!0});const Y=w(()=>v.homeOfficeDays.filter(t=>t.date>=a.value.startOf("month").toFormat("yyyy-MM-dd")&&t.date<=a.value.endOf("month").toFormat("yyyy-MM-dd"))),Z=w(()=>[].concat(v.absencePatches.filter(s=>s.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&s.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(v.absences.filter(s=>s.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&s.end>=a.value.startOf("month").toFormat("yyyy-MM-dd")))),j=w(()=>Z.value.filter(t=>!o.value||(o.value.selected_users.length==0||o.value.selected_users.includes(t.user_id))&&(o.value.selected_absence_types.length==0||!t.absence_type_id||o.value.selected_absence_types.includes(t.absence_type_id))&&(o.value.selected_statuses.length==0||o.value.selected_statuses.includes(t.status)))),A=m(!1),T=m(!1),x=m(!1),_=m(null),C=m(null),b=m(null),B=m(null),L=w(()=>v.users.find(t=>{var s;return t.id===((s=_.value)==null?void 0:s.user_id)})),$=(()=>{var t,s;return route().params.openAbsence?((t=v.absences)==null?void 0:t.find(e=>e.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((s=v.absencePatches)==null?void 0:s.find(e=>e.id==Number(route().params.openAbsencePatch)))??null:null})();$&&(_.value=$,b.value=$.user_id,A.value=!0);function R(t,s){b.value=t,B.value=s??null;const e=j.value.filter(r=>r.user_id===t).find(r=>s&&i.fromSQL(r.start)<=s&&s<=i.fromSQL(r.end));if(e)_.value=e??null,["hasOpenPatch","created"].includes(he(e))?T.value=!0:A.value=!0;else{_.value=null;const r=v.homeOfficeDays.filter(y=>y.user_id===t).find(y=>s&&y.date===s.toFormat("yyyy-MM-dd"));C.value=r??null,r?x.value=!0:A.value=!0}}function ee(){const t=[];for(let s=1;s<=a.value.daysInMonth;s++)t.push(a.value.startOf("month").plus({day:s-1}));return t}function se(){const t=[];for(let s=1;s<=7;s++)t.push(a.value.startOf("week").plus({day:s-1}));return t}const M=m([a.value.toFormat("yyyy-MM")]),H=m(!1),te=fe(()=>{M.value.includes(a.value.toFormat("yyyy-MM"))||ye.reload({only:["absences","absencePatches","holidays","homeOfficeDays","schoolHolidays"],data:{date:a.value.toFormat("yyyy-MM"),openAbsence:null,openAbsencePatch:null},onStart:()=>{M.value.push(a.value.toFormat("yyyy-MM")),H.value=!0},onError:()=>M.value=M.value.filter(t=>t!=a.value.toFormat("yyyy-MM")),onFinish:()=>H.value=!1})},500);W(a,te);const ae=ve(81),c=ne(),G=w(()=>v.schoolHolidays[a.value.toFormat("yyyy-MM")]??{}),z=w(()=>Object.entries(G.value).filter(([t,s])=>{var e,r;return(((e=o.value)==null?void 0:e.selected_holidays.length)==0||((r=o.value)==null?void 0:r.selected_holidays.includes(t)))&&s.length!=0}).flatMap(([t,s])=>[...s].filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))));return(t,s)=>(n(),h(me,{noInlinePadding:l(c).smAndDown.value,title:"Abwesenheiten"},{default:p(()=>[A.value&&b.value?(n(),h(_e,{key:0,absenceTypes:t.absenceTypes,users:t.users,selectedAbsence:_.value,selectedDate:B.value,selectedUser:b.value,"onUpdate:selectedUser":s[0]||(s[0]=e=>b.value=e),modelValue:A.value,"onUpdate:modelValue":s[1]||(s[1]=e=>A.value=e),onAbsenceReload:s[2]||(s[2]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):V("",!0),T.value&&_.value&&L.value?(n(),h(Me,{key:1,absenceTypes:t.absenceTypes,users:t.users,selectedAbsence:_.value,absenceUser:L.value,modelValue:T.value,"onUpdate:modelValue":s[3]||(s[3]=e=>T.value=e),onAbsenceReload:s[4]||(s[4]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","absenceUser","modelValue"])):V("",!0),x.value&&b.value&&C.value?(n(),h(ge,{key:2,selectedHomeOffice:C.value,users:t.users,selectedUser:b.value,"onUpdate:selectedUser":s[5]||(s[5]=e=>b.value=e),modelValue:x.value,"onUpdate:modelValue":s[6]||(s[6]=e=>x.value=e),onHomeOfficeReload:s[7]||(s[7]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["selectedHomeOffice","users","selectedUser","modelValue"])):V("",!0),u(oe,{class:Q({"rounded-0":!l(c).smAndUp.value})},{default:p(()=>[u(re,{class:"px-sm-4 px-0 py-sm-2 py-0"},{default:p(()=>[S("div",{class:Q(["d-flex align-center w-100",l(c).smAndUp.value?"justify-space-between flex-row":"justify-center flex-column"])},[u(pe,{absenceTypes:t.absenceTypes,users:t.users,userAbsenceFilters:t.userAbsenceFilters,filterForm:l(F),"onUpdate:filterForm":s[8]||(s[8]=e=>q(F)?F.value=e:null),singleFilterForm:l(O),"onUpdate:singleFilterForm":s[9]||(s[9]=e=>q(O)?O.value=e:null),schoolHolidays:G.value,federal_state:t.federal_state,all_federal_states:t.all_federal_states,filterableOperatingSites:t.filterableOperatingSites,filterableGroups:t.filterableGroups},null,8,["absenceTypes","users","userAbsenceFilters","filterForm","singleFilterForm","schoolHolidays","federal_state","all_federal_states","filterableOperatingSites","filterableGroups"]),S("div",ke,[S("div",Fe,[l(c).mdAndUp.value?(n(),f(g,{key:0},[u(k,{onClick:s[10]||(s[10]=U(e=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:p(()=>[u(D,{icon:"mdi-chevron-double-left"})]),_:1}),u(k,{onClick:s[11]||(s[11]=U(e=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:p(()=>[u(D,{icon:"mdi-chevron-left"})]),_:1})],64)):(n(),h(k,{key:1,onClick:s[12]||(s[12]=U(e=>a.value=a.value.minus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:p(()=>[u(D,{icon:"mdi-chevron-left"})]),_:1}))]),S("h2",{class:"mx-md-4 text-center",style:J({minWidth:l(c).smAndUp.value?"170px":"110px"})},[l(c).mdAndUp.value?(n(),f(g,{key:0},[K(I(a.value.toFormat("MMMM yyyy")),1)],64)):(n(),f(g,{key:1},[K(I(a.value.startOf("week").toFormat("dd.MM.yy"))+" - "+I(a.value.endOf("week").toFormat("dd.MM.yy")),1)],64)),H.value?(n(),h(ue,{key:2,indeterminate:""})):V("",!0)],4),S("div",Oe,[l(c).mdAndUp.value?(n(),f(g,{key:0},[u(k,{onClick:s[13]||(s[13]=U(e=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:p(()=>[u(D,{icon:"mdi-chevron-right"})]),_:1}),u(k,{onClick:s[14]||(s[14]=U(e=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:p(()=>[u(D,{icon:"mdi-chevron-double-right"})]),_:1})],64)):(n(),h(k,{key:1,onClick:s[15]||(s[15]=U(e=>a.value=a.value.plus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:p(()=>[u(D,{icon:"mdi-chevron-right"})]),_:1}))])]),l(c).smAndUp.value?(n(),f("div",Ae)):V("",!0)],2)]),_:1}),u(de),u(ie,{"fixed-header":"",style:J([{"white-space":"pre"},{maxHeight:l(ae)}]),id:"absence-table",items:t.users.filter(e=>!o.value||(o.value.selected_users.length==0||o.value.selected_users.includes(e.id))&&(o.value.selected_operating_sites.length==0||o.value.selected_operating_sites.includes(e.operating_site_id))&&(o.value.selected_groups.length==0||e.group_id&&o.value.selected_groups.includes(e.group_id))).map(e=>({...e,name:l(c).mdAndUp.value?e.last_name+", "+e.first_name:e.first_name.substring(0,1)+"."+e.last_name})).toSorted((e,r)=>r.id==t.$page.props.auth.user.id?1:e.id==t.$page.props.auth.user.id?-1:e.last_name.localeCompare(r.last_name)),headers:[{title:"Name",key:"name",headerProps:{class:"px-sm-4 px-1"}},...l(c).mdAndUp.value?[{title:"",key:"action",width:"48px",sortable:!1}]:[],...(l(c).mdAndUp.value?ee():se()).map((e,r,y)=>({title:e.weekdayShort+`
`+e.day.toString(),key:e.toString(),sortable:!1,align:"center",width:1/y.length*100+"%",headerProps:{class:{"bg-blue-darken-2":e.toISODate()===l(i).local().toISODate(),"bg-grey":e.toISODate()!==l(i).local().toISODate()&&z.value.some(d=>{const P=l(i).fromISO(d.start),E=l(i).fromISO(d.end);return e>=P&&e<=E})},title:z.value.filter(d=>{const P=l(i).fromISO(d.start),E=l(i).fromISO(d.end);return e>=P&&e<=E}).map(d=>d.name).join(`
`)}}))]},{item:p(({item:e,columns:r})=>[S("tr",null,[(n(!0),f(g,null,ce(r,y=>(n(),f(g,{key:y.key},[y.key==="name"?(n(),f("td",we,I(e.name),1)):y.key==="action"?(n(),f(g,{key:1},[t.can("absence","create",e)?(n(),f("td",Se,[u(k,{icon:"mdi-plus",variant:"text",onClick:d=>t.can("absence","create",e)&&R(e.id)},null,8,["onClick"])])):(n(),f("td",Ue))],64)):(n(),h(be,{key:2,onClick:d=>t.can("absence","create",e)&&R(e.id,l(i).fromISO(y.key)),holidays:t.holidays,absenceTypes:t.absenceTypes,user:e,date:l(i).fromISO(y.key),entries:j.value.filter(d=>d.user_id===e.id),homeOfficeDays:Y.value.filter(d=>d.user_id===e.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries","homeOfficeDays"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1},8,["class"])]),_:1},8,["noInlinePadding"]))}});export{je as default};
