import{d as K,D as w,w as O,r as _,c as S,a as c,b as u,S as q,e as i,g as o,V as W,y as j,i as G,L as B,f as v,M as p,P as C,N as Z,h as a,ad as J,a8 as X,a9 as Y,q as y,t as d,v as k,O as x,aA as ee,j as r,R as z,az as te,a3 as se,z as L,m as f,aB as ie,k as V,F as M,W as oe,A as ae,p as T,B as D,K as re,n as le}from"./app-BtLH69o2.js";import{_ as N}from"./ConfirmDelete.vue_vue_type_script_setup_true_lang-CroE-IvL.js";import{D as $,P as ne}from"./types-BVvW7sCV.js";import{c as A,f as de}from"./utils-B2V-uD95.js";import{_ as ue}from"./RecordCreateDialog.vue_vue_type_script_setup_true_lang-BZuD1E9q.js";const me={class:"d-flex"},pe={class:"d-flex ga-2"},ce=["colspan"],ke={class:"bg-surface-medium"},fe={class:"bg-surface-light"},ge={class:"py-2"},ye={style:{font:"unset"}},be={class:"py-2"},we={style:{font:"unset","max-width":"100%","word-break":"break-word","white-space":"pre-wrap"}},ve={class:"py-2"},Ve={style:{font:"unset"}},he={key:0,style:{width:"1px"}},Te={key:1},Fe={class:"py-2"},Se={style:{width:"1px",padding:"0"}},Ce={style:{width:"1px",padding:"0"}},Le=K({__name:"TicketShowDialog",props:{ticket:{},customers:{},users:{},tab:{},operatingSites:{}},setup(P){const n=P,l=useForm({priority:n.ticket.priority,assignees:n.ticket.assignees.map(e=>e.id),title:n.ticket.title,description:n.ticket.description,selected:n.ticket.records.filter(e=>e.accounted_at).map(e=>e.id),appointment_at:n.ticket.appointment_at?w.fromSQL(n.ticket.appointment_at).toFormat($):null,files:[]});O(()=>n.ticket,()=>{l.defaults({priority:n.ticket.priority,assignees:n.ticket.assignees.map(e=>e.id)??[],title:n.ticket.title,description:n.ticket.description,selected:n.ticket.records.filter(e=>e.accounted_at).map(e=>e.id),appointment_at:n.ticket.appointment_at?w.fromSQL(n.ticket.appointment_at).toFormat($):null}).reset()},{deep:!0});const F=_(Number(route().params.openTicket)==n.ticket.id),U=S(()=>n.ticket.records.length>0),E=S(()=>n.ticket.records.reduce((e,t)=>e+t.duration,0)),H=S(()=>n.ticket.records.filter(e=>l.selected.find(t=>t===e.id)).reduce((e,t)=>e+t.duration,0)),I={accepted:"mdi-check",created:"mdi-timer-sand",declined:"mdi-close"};function R(){var e;if(route().current()==="ticket.show")D.get(route("ticket.index",{tab:n.tab}));else{const t=(e=route().routeParams)==null?void 0:e.customer;t?D.get(route("customer.show",{customer:t,tab:n.tab})):F.value=!1}}function Q(e){navigator.clipboard.writeText(w.fromSQL(e.start).toFormat("dd.MM.yyyy HH:mm")+" - "+w.fromSQL(e.start).plus({seconds:e.duration}).toFormat("HH:mm")+" Uhr, "+e.userName+`

`+(e.description??""))}return(e,t)=>(u(),c(q,{"max-width":"1000px",height:"800px",modelValue:F.value,"onUpdate:modelValue":t[7]||(t[7]=b=>F.value=b)},{activator:i(({props:b})=>[o(f,z({title:"Auftrag anzeigen"},b,{icon:"",variant:"text"}),{default:i(()=>[o(y,{icon:"mdi-eye"})]),_:1},16)]),default:i(({isActive:b})=>[o(re,{onSubmit:T(s=>{a(l).patch(e.route("ticket.update",{ticket:e.ticket.id}),{onSuccess:()=>{a(l).reset(),b.value=!1,R()}})},["prevent"])},{default:i(()=>[o(W,{title:"Auftrag anzeigen"},{append:i(()=>[o(f,{"append-icon":"mdi-arrow-right",title:"Kundenakte öffnen",variant:"flat",color:"info",size:"small",class:"me-2",onClick:t[0]||(t[0]=T(s=>a(D).get(e.route("customer.show",{customer:e.ticket.customer_id,fromTicket:e.ticket.id})),["stop"]))},{default:i(()=>[...t[8]||(t[8]=[d(" zum Kunden ",-1)])]),_:1}),o(f,{icon:"",variant:"text",onClick:T(s=>{b.value=!1,R()},["stop"])},{default:i(()=>[o(y,null,{default:i(()=>[...t[9]||(t[9]=[d("mdi-close",-1)])]),_:1})]),_:1},8,["onClick"])]),default:i(()=>[o(j),o(G,null,{default:i(()=>[o(B,null,{default:i(()=>[o(p,{cols:"12",md:"8"},{default:i(()=>[o(C,{label:"Kunde","model-value":e.ticket.customer.name,disabled:""},null,8,["model-value"])]),_:1}),o(p,{cols:"12",md:"4"},{default:i(()=>[o(Z,{items:a(ne),label:"Priorität",required:"","error-messages":a(l).errors.priority,modelValue:a(l).priority,"onUpdate:modelValue":t[1]||(t[1]=s=>a(l).priority=s),disabled:e.tab!=="newTickets"},{selection:i(({item:s})=>[d(k(s.raw.title)+" ",1),o(y,{class:"ms-2",icon:s.raw.icon,color:s.raw.color},null,8,["icon","color"])]),item:i(({props:s,item:m})=>[o(J,X(Y(s)),{append:i(()=>[o(y,{icon:m.raw.icon,color:m.raw.color},null,8,["icon","color"])]),_:2},1040)]),_:1},8,["items","error-messages","modelValue","disabled"])]),_:1}),o(p,{cols:"12",md:"12"},{default:i(()=>[o(x,{label:"Zuweisung",disabled:e.tab!=="newTickets"&&e.tab!=="workingTickets",required:"",multiple:"",chips:"",modelValue:a(l).assignees,"onUpdate:modelValue":t[2]||(t[2]=s=>a(l).assignees=s),"error-messages":a(l).errors.assignees,items:e.users.map(s=>({value:s.id,title:`${s.first_name} ${s.last_name}`,props:{subtitle:s.job_role??""}}))},{chip:i(({item:s})=>{var m;return[o(te,{"prepend-icon":I[((m=e.ticket.assignees.find(g=>g.id===s.value))==null?void 0:m.pivot.status)??"created"]},null,8,["prepend-icon"])]}),append:i(()=>[o(ee,null,{activator:i(({props:s})=>[o(y,z(s,{icon:"mdi-information-outline",variant:"text",color:"primary"}),null,16)]),default:i(()=>[o(y,null,{default:i(()=>[...t[10]||(t[10]=[d("mdi-check",-1)])]),_:1}),t[13]||(t[13]=d(" : angenommen ",-1)),t[14]||(t[14]=r("br",null,null,-1)),o(y,null,{default:i(()=>[...t[11]||(t[11]=[d("mdi-timer-sand",-1)])]),_:1}),t[15]||(t[15]=d(" : zugewiesen ",-1)),t[16]||(t[16]=r("br",null,null,-1)),o(y,null,{default:i(()=>[...t[12]||(t[12]=[d("mdi-close",-1)])]),_:1}),t[17]||(t[17]=d(" : abgelehnt ",-1))]),_:1})]),_:1},8,["disabled","modelValue","error-messages","items"])]),_:1}),o(p,{cols:"12",md:"9"},{default:i(()=>[o(C,{label:"Betreff",modelValue:a(l).title,"onUpdate:modelValue":t[3]||(t[3]=s=>a(l).title=s),readonly:e.tab==="finishedTickets"||e.tab==="archive","error-messages":a(l).errors.title},null,8,["modelValue","readonly","error-messages"])]),_:1}),o(p,{cols:"12",md:"3"},{default:i(()=>[o(C,{type:"datetime-local",label:"Termin",modelValue:a(l).appointment_at,"onUpdate:modelValue":t[4]||(t[4]=s=>a(l).appointment_at=s),errorMessages:a(l).errors.appointment_at,readonly:e.tab!=="newTickets"&&e.tab!=="workingTickets"},null,8,["modelValue","errorMessages","readonly"])]),_:1}),o(p,{cols:"12"},{default:i(()=>[o(se,{label:"Beschreibung",modelValue:a(l).description,"onUpdate:modelValue":t[5]||(t[5]=s=>a(l).description=s),readonly:e.tab==="finishedTickets"||e.tab==="archive","max-rows":"11","auto-grow":"","error-messages":a(l).errors.description},null,8,["modelValue","readonly","error-messages"])]),_:1}),e.ticket.files.length>0?(u(),c(p,{key:0,cols:"12"},{default:i(()=>[o(L,{items:e.ticket.files,headers:[{title:"Anhang",value:"original_name"},{title:"",value:"actions",width:"1px"}]},{"item.actions":i(({item:s})=>[r("div",me,[s.original_name.endsWith(".pdf")?(u(),c(f,{key:0,variant:"text",href:e.route("ticketFile.show",{ticketFile:s.id}),color:"primary",icon:"mdi-eye"},null,8,["href"])):(u(),c(f,{key:1,variant:"text",href:e.route("ticketFile.getContent",{ticketFile:s.id}),color:"primary",icon:"mdi-download",download:s.original_name},null,8,["href","download"])),o(N,{title:"Datei löschen",content:"Bist du dir sicher, dass du diese Datei löschen möchtest?",route:e.route("ticketFile.destroy",{ticketFile:s.id})},null,8,["route"])])]),_:1},8,["items"])]),_:1})):v("",!0),U.value?(u(),c(L,{key:1,modelValue:a(l).selected,"onUpdate:modelValue":t[6]||(t[6]=s=>a(l).selected=s),headers:[{title:"Start",key:"start"},{title:"Auftragsdauer",key:"duration"},{title:"Erstellt von",key:"userName"},{title:"",key:"actions",width:"1px",sortable:!1}],items:e.ticket.records.map(s=>({...s,userName:s.user.first_name+" "+s.user.last_name})),"show-expand":"","show-select":e.tab!=="archive"&&e.can("ticket","account",e.ticket)},ie({"item.start":i(({item:s})=>[d(k(a(w).fromSQL(s.start).toFormat("dd.MM.yyyy HH:mm")),1)]),"item.duration":i(({item:s})=>[d(k(a(A)(s.duration,"minutes","duration")),1)]),"item.actions":i(({item:s})=>[r("div",pe,[o(f,{variant:"text",color:"primary",title:"Eintrag kopieren",onClick:T(m=>Q(s),["stop"])},{default:i(()=>[o(y,{icon:"mdi-content-copy"})]),_:1},8,["onClick"]),e.tab!="finishedTickets"&&e.tab!=="archive"?(u(),c(ue,{key:0,ticket:e.ticket,users:e.users,record:s,operatingSites:e.operatingSites},null,8,["ticket","users","record","operatingSites"])):v("",!0)])]),"item.data-table-expand":i(({internalItem:s,isExpanded:m,toggleExpand:g})=>[o(f,{size:"small",variant:"text",border:"",onClick:h=>g(s)},{default:i(()=>[o(y,{icon:m(s)?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])]),_:2},1032,["onClick"])]),"expanded-row":i(({columns:s,item:m})=>[r("tr",null,[r("td",{colspan:s.length,class:"py-2"},[o(oe,{density:"compact"},{default:i(()=>[r("tbody",ke,[r("tr",fe,[t[18]||(t[18]=r("th",{style:{width:"1px"}},"Ressourcen",-1)),r("td",ge,[r("pre",ye,k(m.resources),1)]),t[19]||(t[19]=r("td",null,null,-1)),t[20]||(t[20]=r("td",null,null,-1))]),r("tr",null,[t[21]||(t[21]=r("th",{style:{width:"1px"}},"Beschreibung",-1)),r("td",be,[r("pre",we,k(m.description),1)]),t[22]||(t[22]=r("td",null,null,-1)),t[23]||(t[23]=r("td",null,null,-1))]),r("tr",null,[t[24]||(t[24]=r("th",{style:{width:"1px"}},"Standort",-1)),r("td",ve,[r("pre",Ve,k(a(de)(m.address))+" ("+k(m.address.addressable.name)+")",1)]),t[25]||(t[25]=r("td",null,null,-1)),t[26]||(t[26]=r("td",null,null,-1))]),(u(!0),V(M,null,ae(m.files,(g,h)=>(u(),V("tr",{class:le({"bg-surface-light":h%2==0}),key:h},[h==0?(u(),V("th",he,"Anhang")):(u(),V("th",Te)),r("td",Fe,k(g.original_name),1),r("td",Se,[g.original_name.endsWith(".pdf")?(u(),c(f,{key:0,variant:"text",href:e.route("ticketRecordFile.show",{ticketRecordFile:g.id}),color:"primary",icon:"mdi-eye"},null,8,["href"])):(u(),c(f,{key:1,variant:"text",href:e.route("ticketRecordFile.getContent",{ticketRecordFile:g.id}),color:"primary",icon:"mdi-download",download:g.original_name},null,8,["href","download"]))]),r("td",Ce,[o(N,{title:"Datei löschen",content:"Bist du dir sicher, dass du diese Datei löschen möchtest?",route:e.route("ticketRecordFile.destroy",{ticketRecordFile:g.id})},null,8,["route"])])],2))),128))])]),_:2},1024)],8,ce)])]),_:2},[e.tab!=="archive"&&e.can("ticket","account",e.ticket)?{name:"bottom",fn:i(()=>[o(B,{class:"text-end","no-gutters":""},{default:i(()=>[(u(),V(M,{key:0},[o(p,{cols:"12",md:"11"},{default:i(()=>[...t[27]||(t[27]=[d("Ausgewählte Auftragsdauer",-1)])]),_:1}),o(p,{cols:"12",md:"1"},{default:i(()=>[d(k(a(A)(H.value,"minutes","duration")),1)]),_:1})],64)),o(p,{cols:"12",md:"11"},{default:i(()=>[...t[28]||(t[28]=[d("Gesamte Auftragsdauer",-1)])]),_:1}),o(p,{cols:"12",md:"1"},{default:i(()=>[d(k(a(A)(E.value,"minutes","duration")),1)]),_:1})]),_:1})]),key:"0"}:void 0]),1032,["modelValue","items","show-select"])):v("",!0),e.tab!=="archive"?(u(),c(p,{key:2,cols:"12",class:"text-end"},{default:i(()=>[e.can("ticket","account",e.ticket)?(u(),c(f,{key:0,color:"primary",type:"submit",loading:a(l).processing,disabled:!a(l).isDirty},{default:i(()=>[d(k(e.tab==="newTickets"?"Änderungen und Abrechnungen speichern":"Abrechnungen speichern"),1)]),_:1},8,["loading","disabled"])):["newTickets","workingTickets"].includes(e.tab)?(u(),c(f,{key:1,color:"primary",type:"submit",loading:a(l).processing,disabled:!a(l).isDirty},{default:i(()=>[...t[29]||(t[29]=[d(" Änderungen speichern ",-1)])]),_:1},8,["loading","disabled"])):v("",!0)]),_:1})):v("",!0)]),_:1})]),_:1})]),_:2},1024)]),_:2},1032,["onSubmit"])]),_:1},8,["modelValue"]))}});export{Le as _};
