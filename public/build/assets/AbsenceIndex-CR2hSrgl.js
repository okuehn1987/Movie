import{d as ne,r as v,D as y,w as q,c as U,o as oe,u as re,a as h,b as o,e as b,f as T,g as u,V as de,n as J,h as l,i as ue,j as S,k as f,l as K,F as k,m as O,p as D,q as V,s as X,t as Y,v as C,x as ie,y as ce,z as ye,A as me,B as pe}from"./app-LTpOzdcP.js";import{A as ve}from"./AdminLayout-BXnQLrbg.js";import{t as fe,u as be}from"./utils-BkYZrQf_.js";import{_ as _e}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-CzPHK-NP.js";import{_ as he,g as ge}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-U1PWa0Wm.js";import{_ as Me}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-DewD7TMQ.js";import{_ as ke}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang-DykdP2Yr.js";import{_ as Oe}from"./ShowHomeOfficeModal.vue_vue_type_script_setup_true_lang-BR2cf9-P.js";import"./ChatDetails-ZNYMRoOE.js";import"./ChatMessage-B1H-_4QC.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ae={class:"d-flex flex-wrap align-center"},Fe={class:"d-flex"},we={class:"d-flex"},Ue={key:0,style:{width:"64px"}},Se={key:0,style:{"max-width":"calc(100vw - 28px * 7)","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"},class:"px-sm-4 px-1"},De={key:0},Ve={key:1},Le=ne({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absenceTypes:{},holidays:{},schoolHolidays:{},date:{},homeOfficeDays:{},userAbsenceFilters:{},federal_state:{},all_federal_states:{},filterableOperatingSites:{},filterableGroups:{}},setup(Z){const m=Z,B=route().params.date,a=v(B?y.fromFormat(B,"yyyy-MM"):y.now()),A=useForm({set:null,selected_users:[],selected_absence_types:[],selected_operating_sites:[],selected_groups:[],selected_statuses:["created","accepted"],selected_holidays:[m.federal_state],is_default:!1}),n=m.userAbsenceFilters.find(t=>t.is_default),F=useForm({set:(n==null?void 0:n.id)??null,selected_users:(n==null?void 0:n.data.user_ids)??[],selected_absence_types:(n==null?void 0:n.data.absence_type_ids)??[],selected_operating_sites:(n==null?void 0:n.data.operating_site_ids)??[],selected_groups:(n==null?void 0:n.data.group_ids)??[],selected_statuses:(n==null?void 0:n.data.statuses)??["created","accepted"],selected_holidays:(n==null?void 0:n.data.holidays_from_federal_states)??[m.federal_state]}),r=v(F);q([()=>F.data(),()=>A.set],()=>{A.set==null?r.value=F:r.value=A},{deep:!0});const ee=U(()=>m.homeOfficeDays.filter(t=>t.date>=a.value.startOf("month").toFormat("yyyy-MM-dd")&&t.date<=a.value.endOf("month").toFormat("yyyy-MM-dd"))),se=U(()=>[].concat(m.absencePatches.filter(s=>s.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&s.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(m.absences.filter(s=>s.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&s.end>=a.value.startOf("month").toFormat("yyyy-MM-dd")))),j=U(()=>se.value.filter(t=>!r.value||(r.value.selected_users.length==0||r.value.selected_users.includes(t.user_id))&&(r.value.selected_absence_types.length==0||!t.absence_type_id||r.value.selected_absence_types.includes(t.absence_type_id))&&(r.value.selected_statuses.length==0||r.value.selected_statuses.includes(t.status)))),w=v(!1),x=v(!1),I=v(!1),g=v(null),$=v(null),_=v(null),L=v(null),R=U(()=>m.users.find(t=>{var s;return t.id===((s=g.value)==null?void 0:s.user_id)})),H=(()=>{var t,s;return route().params.openAbsence?((t=m.absences)==null?void 0:t.find(e=>e.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((s=m.absencePatches)==null?void 0:s.find(e=>e.id==Number(route().params.openAbsencePatch)))??null:null})();H&&(g.value=H,_.value=H.user_id,w.value=!0);function G(t,s){_.value=t,L.value=s??null;const e=j.value.filter(d=>d.user_id===t).find(d=>s&&y.fromSQL(d.start)<=s&&s<=y.fromSQL(d.end));if(e)g.value=e??null,["hasOpenPatch","created"].includes(ge(e))?x.value=!0:w.value=!0;else{g.value=null;const d=m.homeOfficeDays.filter(p=>p.user_id===t).find(p=>s&&p.date===s.toFormat("yyyy-MM-dd"));$.value=d??null,d?I.value=!0:w.value=!0}}function te(){const t=[];for(let s=1;s<=a.value.daysInMonth;s++)t.push(a.value.startOf("month").plus({day:s-1}));return t}function ae(){const t=[];for(let s=1;s<=7;s++)t.push(a.value.startOf("week").plus({day:s-1}));return t}const M=v([a.value.toFormat("yyyy-MM")]),P=v(!1),z=fe(()=>{const s=(i.mdAndUp.value?[a.value.startOf("month").toFormat("yyyy-MM")]:[a.value.startOf("week").toFormat("yyyy-MM"),a.value.endOf("week").toFormat("yyyy-MM")]).find(e=>!M.value.includes(e));s&&pe.reload({only:["absences","absencePatches","holidays","homeOfficeDays","schoolHolidays"],data:{date:s,openAbsence:null,openAbsencePatch:null},onStart:()=>{M.value.push(s),P.value=!0},onError:()=>M.value=M.value.filter(e=>e!=s),onFinish:()=>P.value=!1})},500);q(a,z),oe(()=>{i.mdAndUp||z()});const le=be(81),i=re(),W=U(()=>m.schoolHolidays[a.value.toFormat("yyyy-MM")]??{}),Q=U(()=>Object.entries(W.value).filter(([t,s])=>{var e,d;return(((e=r.value)==null?void 0:e.selected_holidays.length)==0||((d=r.value)==null?void 0:d.selected_holidays.includes(t)))&&s.length!=0}).flatMap(([t,s])=>[...s].filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))));return(t,s)=>(o(),h(ve,{noInlinePadding:l(i).smAndDown.value,title:"Abwesenheiten"},{default:b(()=>[w.value&&_.value?(o(),h(Me,{key:0,absenceTypes:t.absenceTypes,users:t.users,selectedAbsence:g.value,selectedDate:L.value,selectedUser:_.value,"onUpdate:selectedUser":s[0]||(s[0]=e=>_.value=e),modelValue:w.value,"onUpdate:modelValue":s[1]||(s[1]=e=>w.value=e),onAbsenceReload:s[2]||(s[2]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):T("",!0),x.value&&g.value&&R.value?(o(),h(ke,{key:1,absenceTypes:t.absenceTypes,users:t.users,selectedAbsence:g.value,absenceUser:R.value,modelValue:x.value,"onUpdate:modelValue":s[3]||(s[3]=e=>x.value=e),onAbsenceReload:s[4]||(s[4]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","absenceUser","modelValue"])):T("",!0),I.value&&_.value&&$.value?(o(),h(Oe,{key:2,selectedHomeOffice:$.value,users:t.users,selectedUser:_.value,"onUpdate:selectedUser":s[5]||(s[5]=e=>_.value=e),modelValue:I.value,"onUpdate:modelValue":s[6]||(s[6]=e=>I.value=e),onHomeOfficeReload:s[7]||(s[7]=e=>M.value=[a.value.toFormat("yyyy-MM")])},null,8,["selectedHomeOffice","users","selectedUser","modelValue"])):T("",!0),u(de,{class:J({"rounded-0":!l(i).smAndUp.value})},{default:b(()=>[u(ue,{class:"px-sm-4 px-0 py-sm-2 py-0"},{default:b(()=>[S("div",{class:J(["d-flex align-center w-100",l(i).smAndUp.value?"justify-space-between flex-row":"justify-center flex-column"])},[u(_e,{absenceTypes:t.absenceTypes,users:t.users,userAbsenceFilters:t.userAbsenceFilters,filterForm:l(A),"onUpdate:filterForm":s[8]||(s[8]=e=>K(A)?A.value=e:null),singleFilterForm:l(F),"onUpdate:singleFilterForm":s[9]||(s[9]=e=>K(F)?F.value=e:null),schoolHolidays:W.value,federal_state:t.federal_state,all_federal_states:t.all_federal_states,filterableOperatingSites:t.filterableOperatingSites,filterableGroups:t.filterableGroups},null,8,["absenceTypes","users","userAbsenceFilters","filterForm","singleFilterForm","schoolHolidays","federal_state","all_federal_states","filterableOperatingSites","filterableGroups"]),S("div",Ae,[S("div",Fe,[l(i).mdAndUp.value?(o(),f(k,{key:0},[u(O,{onClick:s[10]||(s[10]=D(e=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-double-left"})]),_:1}),u(O,{onClick:s[11]||(s[11]=D(e=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-left"})]),_:1})],64)):(o(),h(O,{key:1,onClick:s[12]||(s[12]=D(e=>a.value=a.value.minus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-left"})]),_:1}))]),S("h2",{class:"mx-md-4 text-center",style:X({minWidth:l(i).smAndUp.value?"170px":"110px"})},[l(i).mdAndUp.value?(o(),f(k,{key:0},[Y(C(a.value.toFormat("MMMM yyyy")),1)],64)):(o(),f(k,{key:1},[Y(C(a.value.startOf("week").toFormat("dd.MM.yy"))+" - "+C(a.value.endOf("week").toFormat("dd.MM.yy")),1)],64)),P.value?(o(),h(ie,{key:2,indeterminate:""})):T("",!0)],4),S("div",we,[l(i).mdAndUp.value?(o(),f(k,{key:0},[u(O,{onClick:s[13]||(s[13]=D(e=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-right"})]),_:1}),u(O,{onClick:s[14]||(s[14]=D(e=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-double-right"})]),_:1})],64)):(o(),h(O,{key:1,onClick:s[15]||(s[15]=D(e=>a.value=a.value.plus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-right"})]),_:1}))])]),l(i).smAndUp.value?(o(),f("div",Ue)):T("",!0)],2)]),_:1}),u(ce),u(ye,{"fixed-header":"",style:X([{"white-space":"pre"},{maxHeight:l(le)}]),id:"absence-table",items:t.users.filter(e=>!r.value||(r.value.selected_users.length==0||r.value.selected_users.includes(e.id))&&(r.value.selected_operating_sites.length==0||r.value.selected_operating_sites.includes(e.operating_site_id))&&(r.value.selected_groups.length==0||e.group_id&&r.value.selected_groups.includes(e.group_id))).map(e=>({...e,name:l(i).mdAndUp.value?e.last_name+", "+e.first_name:e.first_name.substring(0,1)+"."+e.last_name})).toSorted((e,d)=>d.id==t.$page.props.auth.user.id?1:e.id==t.$page.props.auth.user.id?-1:e.last_name.localeCompare(d.last_name)),headers:[{title:"Name",key:"name",headerProps:{class:"px-sm-4 px-1"}},...l(i).mdAndUp.value?[{title:"",key:"action",width:"48px",sortable:!1}]:[],...(l(i).mdAndUp.value?te():ae()).map((e,d,p)=>({title:e.weekdayShort+`
`+e.day.toString(),key:e.toString(),sortable:!1,align:"center",width:1/p.length*100+"%",headerProps:{class:{"bg-blue-darken-2":e.toISODate()===l(y).local().toISODate(),"bg-grey":e.toISODate()!==l(y).local().toISODate()&&Q.value.some(c=>{const E=l(y).fromISO(c.start),N=l(y).fromISO(c.end);return e>=E&&e<=N})},title:Q.value.filter(c=>{const E=l(y).fromISO(c.start),N=l(y).fromISO(c.end);return e>=E&&e<=N}).map(c=>c.name).join(`
`)}}))]},{item:b(({item:e,columns:d})=>[S("tr",null,[(o(!0),f(k,null,me(d,p=>(o(),f(k,{key:p.key},[p.key==="name"?(o(),f("td",Se,C(e.name),1)):p.key==="action"?(o(),f(k,{key:1},[t.can("absence","create",e)?(o(),f("td",De,[u(O,{icon:"mdi-plus",variant:"text",onClick:c=>t.can("absence","create",e)&&G(e.id)},null,8,["onClick"])])):(o(),f("td",Ve))],64)):(o(),h(he,{key:2,onClick:c=>t.can("absence","create",e)&&G(e.id,l(y).fromISO(p.key)),holidays:t.holidays,absenceTypes:t.absenceTypes,user:e,date:l(y).fromISO(p.key),entries:j.value.filter(c=>c.user_id===e.id),homeOfficeDays:ee.value.filter(c=>c.user_id===e.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries","homeOfficeDays"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1},8,["class"])]),_:1},8,["noInlinePadding"]))}});export{Le as default};
