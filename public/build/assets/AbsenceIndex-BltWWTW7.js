import{d as ne,r as v,D as c,w as Q,c as S,u as oe,a as h,o,b,e as T,f as u,V as re,n as q,g as l,h as de,i as U,j as f,k as J,F as k,l as O,m as D,p as V,q as K,s as X,t as C,v as ue,x as ie,y as ce,z as ye,A as me}from"./app-WqVMu7xc.js";import{A as pe}from"./AdminLayout-EU38lDPi.js";import{t as ve,u as fe}from"./utils-KCmv7dPD.js";import{_ as be}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-CL_aRLUh.js";import{_ as _e,g as he}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-D70P_Ok3.js";import{_ as Me}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-D5tM_ccc.js";import{_ as ge}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang--GAaMt9g.js";import{_ as ke}from"./ShowHomeOfficeModal.vue_vue_type_script_setup_true_lang-IwMLsObA.js";import"./ChatDetails-KFNu6wOV.js";import"./ChatMessage--Lh0NJBZ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Oe={class:"d-flex flex-wrap align-center"},Ae={class:"d-flex"},Fe={class:"d-flex"},we={key:0,style:{width:"64px"}},Se={key:0,style:{"max-width":"calc(100vw - 28px * 7)","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"},class:"px-sm-4 px-1"},Ue={key:0},De={key:1},Be=ne({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absenceTypes:{},holidays:{},schoolHolidays:{},date:{},homeOfficeDays:{},userAbsenceFilters:{},federal_state:{},all_federal_states:{},filterableOperatingSites:{},filterableGroups:{}},setup(Y){const y=Y,j=route().params.date,a=v(j?c.fromFormat(j,"yyyy-MM"):c.now()),A=useForm({set:null,selected_users:[],selected_absence_types:[],selected_operating_sites:[],selected_groups:[],selected_statuses:["created","accepted"],selected_holidays:[y.federal_state],is_default:!1}),n=y.userAbsenceFilters.find(t=>t.is_default),F=useForm({set:(n==null?void 0:n.id)??null,selected_users:(n==null?void 0:n.data.user_ids)??[],selected_absence_types:(n==null?void 0:n.data.absence_type_ids)??[],selected_operating_sites:(n==null?void 0:n.data.operating_site_ids)??[],selected_groups:(n==null?void 0:n.data.group_ids)??[],selected_statuses:(n==null?void 0:n.data.statuses)??["created","accepted"],selected_holidays:(n==null?void 0:n.data.holidays_from_federal_states)??[y.federal_state]}),r=v(F);Q([()=>F.data(),()=>A.set],()=>{A.set==null?r.value=F:r.value=A},{deep:!0});const Z=S(()=>y.homeOfficeDays.filter(t=>t.date>=a.value.startOf("month").toFormat("yyyy-MM-dd")&&t.date<=a.value.endOf("month").toFormat("yyyy-MM-dd"))),ee=S(()=>[].concat(y.absencePatches.filter(s=>s.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&s.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(y.absences.filter(s=>s.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&s.end>=a.value.startOf("month").toFormat("yyyy-MM-dd")))),B=S(()=>ee.value.filter(t=>!r.value||(r.value.selected_users.length==0||r.value.selected_users.includes(t.user_id))&&(r.value.selected_absence_types.length==0||!t.absence_type_id||r.value.selected_absence_types.includes(t.absence_type_id))&&(r.value.selected_statuses.length==0||r.value.selected_statuses.includes(t.status)))),w=v(!1),x=v(!1),I=v(!1),M=v(null),$=v(null),_=v(null),L=v(null),R=S(()=>y.users.find(t=>{var s;return t.id===((s=M.value)==null?void 0:s.user_id)})),H=(()=>{var t,s;return route().params.openAbsence?((t=y.absences)==null?void 0:t.find(e=>e.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((s=y.absencePatches)==null?void 0:s.find(e=>e.id==Number(route().params.openAbsencePatch)))??null:null})();H&&(M.value=H,_.value=H.user_id,w.value=!0);function G(t,s){_.value=t,L.value=s??null;const e=B.value.filter(d=>d.user_id===t).find(d=>s&&c.fromSQL(d.start)<=s&&s<=c.fromSQL(d.end));if(e)M.value=e??null,["hasOpenPatch","created"].includes(he(e))?x.value=!0:w.value=!0;else{M.value=null;const d=y.homeOfficeDays.filter(p=>p.user_id===t).find(p=>s&&p.date===s.toFormat("yyyy-MM-dd"));$.value=d??null,d?I.value=!0:w.value=!0}}function se(){const t=[];for(let s=1;s<=a.value.daysInMonth;s++)t.push(a.value.startOf("month").plus({day:s-1}));return t}function te(){const t=[];for(let s=1;s<=7;s++)t.push(a.value.startOf("week").plus({day:s-1}));return t}const g=v([a.value.toFormat("yyyy-MM")]),P=v(!1),ae=ve(()=>{g.value.includes(a.value.toFormat("yyyy-MM"))||me.reload({only:["absences","absencePatches","holidays","homeOfficeDays","schoolHolidays"],data:{date:a.value.toFormat("yyyy-MM"),openAbsence:null,openAbsencePatch:null},onStart:()=>{g.value.push(a.value.toFormat("yyyy-MM")),P.value=!0},onError:()=>g.value=g.value.filter(t=>t!=a.value.toFormat("yyyy-MM")),onFinish:()=>P.value=!1})},500);Q(a,ae);const le=fe(81),m=oe(),z=S(()=>y.schoolHolidays[a.value.toFormat("yyyy-MM")]??{}),W=S(()=>Object.entries(z.value).filter(([t,s])=>{var e,d;return(((e=r.value)==null?void 0:e.selected_holidays.length)==0||((d=r.value)==null?void 0:d.selected_holidays.includes(t)))&&s.length!=0}).flatMap(([t,s])=>[...s].filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))));return(t,s)=>(o(),h(pe,{noInlinePadding:l(m).smAndDown.value,title:"Abwesenheiten"},{default:b(()=>[w.value&&_.value?(o(),h(Me,{key:0,absenceTypes:t.absenceTypes,users:t.users,selectedAbsence:M.value,selectedDate:L.value,selectedUser:_.value,"onUpdate:selectedUser":s[0]||(s[0]=e=>_.value=e),modelValue:w.value,"onUpdate:modelValue":s[1]||(s[1]=e=>w.value=e),onAbsenceReload:s[2]||(s[2]=e=>g.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):T("",!0),x.value&&M.value&&R.value?(o(),h(ge,{key:1,absenceTypes:t.absenceTypes,users:t.users,selectedAbsence:M.value,absenceUser:R.value,modelValue:x.value,"onUpdate:modelValue":s[3]||(s[3]=e=>x.value=e),onAbsenceReload:s[4]||(s[4]=e=>g.value=[a.value.toFormat("yyyy-MM")])},null,8,["absenceTypes","users","selectedAbsence","absenceUser","modelValue"])):T("",!0),I.value&&_.value&&$.value?(o(),h(ke,{key:2,selectedHomeOffice:$.value,users:t.users,selectedUser:_.value,"onUpdate:selectedUser":s[5]||(s[5]=e=>_.value=e),modelValue:I.value,"onUpdate:modelValue":s[6]||(s[6]=e=>I.value=e),onHomeOfficeReload:s[7]||(s[7]=e=>g.value=[a.value.toFormat("yyyy-MM")])},null,8,["selectedHomeOffice","users","selectedUser","modelValue"])):T("",!0),u(re,{class:q({"rounded-0":!l(m).smAndUp.value})},{default:b(()=>[u(de,{class:"px-sm-4 px-0 py-sm-2 py-0"},{default:b(()=>[U("div",{class:q(["d-flex align-center w-100",l(m).smAndUp.value?"justify-space-between flex-row":"justify-center flex-column"])},[u(be,{absenceTypes:t.absenceTypes,users:t.users,userAbsenceFilters:t.userAbsenceFilters,filterForm:l(A),"onUpdate:filterForm":s[8]||(s[8]=e=>J(A)?A.value=e:null),singleFilterForm:l(F),"onUpdate:singleFilterForm":s[9]||(s[9]=e=>J(F)?F.value=e:null),schoolHolidays:z.value,federal_state:t.federal_state,all_federal_states:t.all_federal_states,filterableOperatingSites:t.filterableOperatingSites,filterableGroups:t.filterableGroups},null,8,["absenceTypes","users","userAbsenceFilters","filterForm","singleFilterForm","schoolHolidays","federal_state","all_federal_states","filterableOperatingSites","filterableGroups"]),U("div",Oe,[U("div",Ae,[l(m).mdAndUp.value?(o(),f(k,{key:0},[u(O,{onClick:s[10]||(s[10]=D(e=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-double-left"})]),_:1}),u(O,{onClick:s[11]||(s[11]=D(e=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-left"})]),_:1})],64)):(o(),h(O,{key:1,onClick:s[12]||(s[12]=D(e=>a.value=a.value.minus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-left"})]),_:1}))]),U("h2",{class:"mx-md-4 text-center",style:K({minWidth:l(m).smAndUp.value?"170px":"110px"})},[l(m).mdAndUp.value?(o(),f(k,{key:0},[X(C(a.value.toFormat("MMMM yyyy")),1)],64)):(o(),f(k,{key:1},[X(C(a.value.startOf("week").toFormat("dd.MM.yy"))+" - "+C(a.value.endOf("week").toFormat("dd.MM.yy")),1)],64)),P.value?(o(),h(ue,{key:2,indeterminate:""})):T("",!0)],4),U("div",Fe,[l(m).mdAndUp.value?(o(),f(k,{key:0},[u(O,{onClick:s[13]||(s[13]=D(e=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-right"})]),_:1}),u(O,{onClick:s[14]||(s[14]=D(e=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-double-right"})]),_:1})],64)):(o(),h(O,{key:1,onClick:s[15]||(s[15]=D(e=>a.value=a.value.plus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:b(()=>[u(V,{icon:"mdi-chevron-right"})]),_:1}))])]),l(m).smAndUp.value?(o(),f("div",we)):T("",!0)],2)]),_:1}),u(ie),u(ce,{"fixed-header":"",style:K([{"white-space":"pre"},{maxHeight:l(le)}]),id:"absence-table",items:t.users.filter(e=>!r.value||(r.value.selected_users.length==0||r.value.selected_users.includes(e.id))&&(r.value.selected_operating_sites.length==0||r.value.selected_operating_sites.includes(e.operating_site_id))&&(r.value.selected_groups.length==0||e.group_id&&r.value.selected_groups.includes(e.group_id))).map(e=>({...e,name:l(m).mdAndUp.value?e.last_name+", "+e.first_name:e.first_name.substring(0,1)+"."+e.last_name})).toSorted((e,d)=>d.id==t.$page.props.auth.user.id?1:e.id==t.$page.props.auth.user.id?-1:e.last_name.localeCompare(d.last_name)),headers:[{title:"Name",key:"name",headerProps:{class:"px-sm-4 px-1"}},...l(m).mdAndUp.value?[{title:"",key:"action",width:"48px",sortable:!1}]:[],...(l(m).mdAndUp.value?se():te()).map((e,d,p)=>({title:e.weekdayShort+`
`+e.day.toString(),key:e.toString(),sortable:!1,align:"center",width:1/p.length*100+"%",headerProps:{class:{"bg-blue-darken-2":e.toISODate()===l(c).local().toISODate(),"bg-grey":e.toISODate()!==l(c).local().toISODate()&&W.value.some(i=>{const E=l(c).fromISO(i.start),N=l(c).fromISO(i.end);return e>=E&&e<=N})},title:W.value.filter(i=>{const E=l(c).fromISO(i.start),N=l(c).fromISO(i.end);return e>=E&&e<=N}).map(i=>i.name).join(`
`)}}))]},{item:b(({item:e,columns:d})=>[U("tr",null,[(o(!0),f(k,null,ye(d,p=>(o(),f(k,{key:p.key},[p.key==="name"?(o(),f("td",Se,C(e.name),1)):p.key==="action"?(o(),f(k,{key:1},[t.can("absence","create",e)?(o(),f("td",Ue,[u(O,{icon:"mdi-plus",variant:"text",onClick:i=>t.can("absence","create",e)&&G(e.id)},null,8,["onClick"])])):(o(),f("td",De))],64)):(o(),h(_e,{key:2,onClick:i=>t.can("absence","create",e)&&G(e.id,l(c).fromISO(p.key)),holidays:t.holidays,absenceTypes:t.absenceTypes,user:e,date:l(c).fromISO(p.key),entries:B.value.filter(i=>i.user_id===e.id),homeOfficeDays:Z.value.filter(i=>i.user_id===e.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries","homeOfficeDays"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1},8,["class"])]),_:1},8,["noInlinePadding"]))}});export{Be as default};
