import{d as H,r as u,D as b,c as T,w as j,a as _,o as r,b as i,e as x,f as n,V as Q,g as R,h as d,i as q,u as h,j as M,k as F,l as V,m as z,t as I,n as G,p as J,q as K,s as W,v as y,F as S,x as X,y as Y}from"./app-D-CalFh6.js";import{_ as Z}from"./AdminLayout.vue_vue_type_script_setup_true_lang-COPy40w-.js";import{t as ee,u as se}from"./utils-B4angkH8.js";import{_ as te,g as ae}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-DAIsCyRQ.js";import{_ as ne}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-wQ5Y2xUj.js";import{_ as le}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang-CgI8gGUv.js";import{_ as re}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-DIR2X2fO.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const oe={class:"d-flex flex-wrap justify-space-between align-center"},ue={class:"d-flex flex-wrap align-center"},ie={class:"d-flex"},de={class:"mx-4 text-center",style:{"min-width":"170px"}},ce={class:"d-flex"},ye={key:0},me={key:0},pe={key:1},Fe=H({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absence_types:{},holidays:{},user_absence_filters:{}},setup(N){const m=N,D=route().params.date,a=u(D?b.fromFormat(D,"yyyy-MM"):b.now()),l=useForm({set:null,selected_users:[],selected_absence_types:[],selected_statuses:["created","accepted"]}),U=T(()=>[].concat(m.absencePatches.filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(m.absences.filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).filter(e=>(l.selected_users.length==0||l.selected_users.includes(e.user_id))&&(l.selected_absence_types.length==0||!e.absence_type_id||l.selected_absence_types.includes(e.absence_type_id))&&(l.selected_statuses.length==0||l.selected_statuses.includes(e.status)))),p=u(!1),k=u(!1),c=u(null),f=u(null),$=u(null),O=T(()=>m.users.find(t=>{var e;return t.id===((e=c.value)==null?void 0:e.user_id)})),w=(()=>{var t,e;return route().params.openAbsence?((t=m.absences)==null?void 0:t.find(s=>s.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((e=m.absencePatches)==null?void 0:e.find(s=>s.id==Number(route().params.openAbsencePatch)))??null:null})();w&&(c.value=w,f.value=w.user_id,p.value=!0);function P(t,e){f.value=t;const s=U.value.filter(o=>o.user_id===t).find(o=>e&&b.fromSQL(o.start)<=e&&e<=b.fromSQL(o.end));$.value=e??null,c.value=s??null,s&&["hasOpenPatch","created"].includes(ae(s))?k.value=!0:p.value=!0}function E(){const t=[];for(let e=1;e<=a.value.daysInMonth;e++)t.push(a.value.startOf("month").plus({day:e-1}));return t}const g=u([a.value.toFormat("yyyy-MM")]),A=u(!1),B=ee(()=>{g.value.includes(a.value.toFormat("yyyy-MM"))||Y.reload({only:["absences","holidays"],data:{date:a.value.toFormat("yyyy-MM")},onStart:()=>{g.value.push(a.value.toFormat("yyyy-MM")),A.value=!0},onError:()=>g.value=g.value.filter(t=>t!=a.value.toFormat("yyyy-MM")),onFinish:()=>A.value=!1})},500);j(a,B);const L=se(81);return(t,e)=>(r(),_(Z,{title:"Abwesenheiten"},{default:i(()=>[p.value&&f.value?(r(),_(ne,{key:0,absence_types:t.absence_types,users:t.users,selectedAbsence:c.value,selectedDate:$.value,selectedUser:f.value,"onUpdate:selectedUser":e[0]||(e[0]=s=>f.value=s),modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=s=>p.value=s)},null,8,["absence_types","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):x("",!0),k.value&&c.value&&O.value?(r(),_(le,{key:1,absence_types:t.absence_types,users:t.users,selectedAbsence:c.value,absenceUser:O.value,modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=s=>k.value=s)},null,8,["absence_types","users","selectedAbsence","absenceUser","modelValue"])):x("",!0),n(Q,null,{default:i(()=>[n(R,null,{default:i(()=>[d("div",oe,[n(re,{absence_types:t.absence_types,users:t.users,user_absence_filters:t.user_absence_filters,filterForm:h(l),"onUpdate:filterForm":e[3]||(e[3]=s=>q(l)?l.value=s:null)},null,8,["absence_types","users","user_absence_filters","filterForm"]),d("div",ue,[d("div",ie,[n(M,{onClick:e[4]||(e[4]=F(s=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(V,{icon:"mdi-chevron-double-left"})]),_:1}),n(M,{onClick:e[5]||(e[5]=F(s=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(V,{icon:"mdi-chevron-left"})]),_:1})]),d("h2",de,[z(I(a.value.toFormat("MMMM yyyy"))+" ",1),A.value?(r(),_(G,{key:0,indeterminate:""})):x("",!0)]),d("div",ce,[n(M,{onClick:e[6]||(e[6]=F(s=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(V,{icon:"mdi-chevron-right"})]),_:1}),n(M,{onClick:e[7]||(e[7]=F(s=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(V,{icon:"mdi-chevron-double-right"})]),_:1})])]),e[8]||(e[8]=d("div",{style:{width:"64px"}},null,-1))])]),_:1}),n(J),n(K,{"fixed-header":"",style:W([{"white-space":"pre"},{maxHeight:h(L)}]),id:"absence-table",items:t.users.filter(s=>h(l).selected_users.length==0||h(l).selected_users.includes(s.id)).map(s=>({...s,name:s.last_name+", "+s.first_name})).toSorted((s,o)=>s.name.localeCompare(o.name)),headers:[{title:"Name",key:"name"},{title:"",key:"action",width:"48px",sortable:!1},...E().map(s=>({title:s.weekdayShort+`
`+s.day.toString(),key:s.day.toString(),sortable:!1,align:"center",width:"44px",headerProps:{class:{"bg-blue-darken-2":s.toISODate()===h(b).local().toISODate()}}}))]},{item:i(({item:s,columns:o})=>[d("tr",null,[(r(!0),y(S,null,X(o,v=>(r(),y(S,{key:v.key},[v.key==="name"?(r(),y("td",ye,I(s.name),1)):v.key==="action"?(r(),y(S,{key:1},[t.can("absence","create",s)?(r(),y("td",me,[n(M,{icon:"mdi-plus",variant:"text",onClick:C=>t.can("absence","create",s)&&P(s.id)},null,8,["onClick"])])):(r(),y("td",pe))],64)):(r(),_(te,{key:2,onClick:C=>t.can("absence","create",s)&&P(s.id,a.value.startOf("month").plus({day:+(v.key??0)-1})),holidays:t.holidays,absenceTypes:t.absence_types,user:s,date:a.value.startOf("month").plus({day:+(v.key??0)-1}),entries:U.value.filter(C=>C.user_id===s.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1})]),_:1}))}});export{Fe as default};
