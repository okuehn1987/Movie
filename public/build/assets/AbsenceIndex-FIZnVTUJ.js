import{d as K,r as y,D as v,w as L,c as P,u as X,a as p,o as l,b as i,e as C,f as n,V as Y,g as Z,h as M,n as ee,i as r,j as u,k as R,F as f,l as b,m as F,p as g,q as j,s as z,t as S,v as se,x as te,y as ae,z as le,A as ne}from"./app-Des6fyTD.js";import{A as re}from"./AdminLayout-B8DRHQfI.js";import{t as oe,u as ue}from"./utils-CHWXwqL9.js";import{_ as de}from"./AbsenceFilter.vue_vue_type_script_setup_true_lang-BGLz1gOq.js";import{_ as ie,g as ce}from"./AbsenceTableCell.vue_vue_type_style_index_0_lang-BMtuObLS.js";import{_ as ye}from"./EditCreateAbsence.vue_vue_type_script_setup_true_lang-bQxTf1cD.js";import{_ as me}from"./ShowAbsenceModal.vue_vue_type_script_setup_true_lang-Ba3lPowd.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ve={class:"d-flex flex-wrap align-center"},pe={class:"d-flex"},fe={class:"d-flex"},be={key:0,style:{width:"64px"}},_e={key:0,style:{"max-width":"calc(100vw - 28px * 7)","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"},class:"px-sm-4 px-1"},he={key:0},ke={key:1},Ce=K({__name:"AbsenceIndex",props:{users:{},absences:{},absencePatches:{},absence_types:{},holidays:{},date:{},user_absence_filters:{}},setup(H){const A=H,I=route().params.date,a=y(I?v.fromFormat(I,"yyyy-MM"):v.now()),_=useForm({set:null,selected_users:[],selected_absence_types:[],selected_statuses:["created","accepted"]}),w=useForm({set:null,selected_users:[],selected_absence_types:[],selected_statuses:["created","accepted"]}),o=y(null);L([()=>w.data(),()=>_.set],()=>{_.set==null?o.value=w:o.value=_},{deep:!0});const W=P(()=>[].concat(A.absencePatches.filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd"))).concat(A.absences.filter(e=>e.start<=a.value.endOf("month").toFormat("yyyy-MM-dd")&&e.end>=a.value.startOf("month").toFormat("yyyy-MM-dd")))),T=P(()=>W.value.filter(t=>!o.value||(o.value.selected_users.length==0||o.value.selected_users.includes(t.user_id))&&(o.value.selected_absence_types.length==0||!t.absence_type_id||o.value.selected_absence_types.includes(t.absence_type_id))&&(o.value.selected_statuses.length==0||o.value.selected_statuses.includes(t.status)))),x=y(!1),V=y(!1),h=y(null),U=y(null),E=y(null),N=P(()=>A.users.find(t=>{var e;return t.id===((e=h.value)==null?void 0:e.user_id)})),$=(()=>{var t,e;return route().params.openAbsence?((t=A.absences)==null?void 0:t.find(s=>s.id==Number(route().params.openAbsence)))??null:route().params.openAbsencePatch?((e=A.absencePatches)==null?void 0:e.find(s=>s.id==Number(route().params.openAbsencePatch)))??null:null})();$&&(h.value=$,U.value=$.user_id,x.value=!0);function B(t,e){U.value=t;const s=T.value.filter(d=>d.user_id===t).find(d=>e&&v.fromSQL(d.start)<=e&&e<=v.fromSQL(d.end));E.value=e??null,h.value=s??null,s&&["hasOpenPatch","created"].includes(ce(s))?V.value=!0:x.value=!0}function Q(){const t=[];for(let e=1;e<=a.value.daysInMonth;e++)t.push(a.value.startOf("month").plus({day:e-1}));return t}function q(){const t=[];for(let e=1;e<=7;e++)t.push(a.value.startOf("week").plus({day:e-1}));return t}const k=y([a.value.toFormat("yyyy-MM")]),D=y(!1),G=oe(()=>{k.value.includes(a.value.toFormat("yyyy-MM"))||ne.reload({only:["absences","absencePatches","holidays"],data:{date:a.value.toFormat("yyyy-MM"),openAbsence:null,openAbsencePatch:null},onStart:()=>{k.value.push(a.value.toFormat("yyyy-MM")),D.value=!0},onError:()=>k.value=k.value.filter(t=>t!=a.value.toFormat("yyyy-MM")),onFinish:()=>D.value=!1})},500);L(a,G);const J=ue(81),c=X();return(t,e)=>(l(),p(re,{title:"Abwesenheiten"},{default:i(()=>[x.value&&U.value?(l(),p(ye,{key:0,absence_types:t.absence_types,users:t.users,selectedAbsence:h.value,selectedDate:E.value,selectedUser:U.value,"onUpdate:selectedUser":e[0]||(e[0]=s=>U.value=s),modelValue:x.value,"onUpdate:modelValue":e[1]||(e[1]=s=>x.value=s),onAbsenceReload:e[2]||(e[2]=s=>k.value=[a.value.toFormat("yyyy-MM")])},null,8,["absence_types","users","selectedAbsence","selectedDate","selectedUser","modelValue"])):C("",!0),V.value&&h.value&&N.value?(l(),p(me,{key:1,absence_types:t.absence_types,users:t.users,selectedAbsence:h.value,absenceUser:N.value,modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=s=>V.value=s),onAbsenceReload:e[4]||(e[4]=s=>k.value=[a.value.toFormat("yyyy-MM")])},null,8,["absence_types","users","selectedAbsence","absenceUser","modelValue"])):C("",!0),n(Y,null,{default:i(()=>[n(Z,{class:"px-sm-4 px-0"},{default:i(()=>[M("div",{class:ee(["d-flex align-center w-100",r(c).mdAndUp.value?"justify-space-between":"justify-center"])},[n(de,{absence_types:t.absence_types,users:t.users,user_absence_filters:t.user_absence_filters,filterForm:r(_),"onUpdate:filterForm":e[5]||(e[5]=s=>R(_)?_.value=s:null),singleFilterForm:r(w),"onUpdate:singleFilterForm":e[6]||(e[6]=s=>R(w)?w.value=s:null)},null,8,["absence_types","users","user_absence_filters","filterForm","singleFilterForm"]),M("div",ve,[M("div",pe,[r(c).mdAndUp.value?(l(),u(f,{key:0},[n(b,{onClick:e[7]||(e[7]=F(s=>a.value=a.value.minus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(g,{icon:"mdi-chevron-double-left"})]),_:1}),n(b,{onClick:e[8]||(e[8]=F(s=>a.value=a.value.minus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(g,{icon:"mdi-chevron-left"})]),_:1})],64)):(l(),p(b,{key:1,onClick:e[9]||(e[9]=F(s=>a.value=a.value.minus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(g,{icon:"mdi-chevron-left"})]),_:1}))]),M("h2",{class:"mx-md-4 text-center",style:j({minWidth:r(c).mdAndUp.value?"170px":"110px"})},[r(c).mdAndUp.value?(l(),u(f,{key:0},[z(S(a.value.toFormat("MMMM yyyy")),1)],64)):(l(),u(f,{key:1},[z(S(a.value.startOf("week").toFormat("dd.MM.yy"))+" - "+S(a.value.endOf("week").toFormat("dd.MM.yy")),1)],64)),D.value?(l(),p(se,{key:2,indeterminate:""})):C("",!0)],4),M("div",fe,[r(c).mdAndUp.value?(l(),u(f,{key:0},[n(b,{onClick:e[10]||(e[10]=F(s=>a.value=a.value.plus({month:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(g,{icon:"mdi-chevron-right"})]),_:1}),n(b,{onClick:e[11]||(e[11]=F(s=>a.value=a.value.plus({year:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(g,{icon:"mdi-chevron-double-right"})]),_:1})],64)):(l(),p(b,{key:1,onClick:e[12]||(e[12]=F(s=>a.value=a.value.plus({week:1}),["stop"])),variant:"text",icon:"",color:"primary"},{default:i(()=>[n(g,{icon:"mdi-chevron-right"})]),_:1}))])]),r(c).mdAndUp.value?(l(),u("div",be)):C("",!0)],2)]),_:1}),n(te),n(ae,{"fixed-header":"",style:j([{"white-space":"pre"},{maxHeight:r(J)}]),id:"absence-table",items:t.users.filter(s=>!o.value||o.value.selected_users.length==0||o.value.selected_users.includes(s.id)).map(s=>({...s,name:r(c).mdAndUp.value?s.last_name+", "+s.first_name:s.first_name.substring(0,1)+"."+s.last_name})).toSorted((s,d)=>d.id==t.$page.props.auth.user.id?1:s.last_name.localeCompare(d.last_name)),headers:[{title:"Name",key:"name",headerProps:{class:"px-sm-4 px-1"}},...r(c).mdAndUp.value?[{title:"",key:"action",width:"48px",sortable:!1}]:[],...(r(c).mdAndUp.value?Q():q()).map((s,d,m)=>({title:s.weekdayShort+`
`+s.day.toString(),key:s.toString(),sortable:!1,align:"center",width:1/m.length*100+"%",headerProps:{class:{"bg-blue-darken-2":s.toISODate()===r(v).local().toISODate()}}}))]},{item:i(({item:s,columns:d})=>[M("tr",null,[(l(!0),u(f,null,le(d,m=>(l(),u(f,{key:m.key},[m.key==="name"?(l(),u("td",_e,S(s.name),1)):m.key==="action"?(l(),u(f,{key:1},[t.can("absence","create",s)?(l(),u("td",he,[n(b,{icon:"mdi-plus",variant:"text",onClick:O=>t.can("absence","create",s)&&B(s.id)},null,8,["onClick"])])):(l(),u("td",ke))],64)):(l(),p(ie,{key:2,onClick:O=>t.can("absence","create",s)&&B(s.id,r(v).fromISO(m.key)),holidays:t.holidays,absenceTypes:t.absence_types,user:s,date:r(v).fromISO(m.key),entries:T.value.filter(O=>O.user_id===s.id)},null,8,["onClick","holidays","absenceTypes","user","date","entries"]))],64))),128))])]),_:1},8,["style","items","headers"])]),_:1})]),_:1}))}});export{Ce as default};
